<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海事局VTS值班人事管理系统</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FullCalendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    <style>
        /* 基础样式优化 */
        html, body {
            scroll-behavior: smooth;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .page {
            display: none;
            min-height: 100vh;
            width: 100%;
        }
        .page.active {
            display: block;
        }
        
        /* 登录页面居中修复 */
        #loginPage, #registerPage {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        #loginPage.active, #registerPage.active {
            display: flex !important;
        }
        
        /* 头部固定优化 */
        .main-header {
            position: sticky;
            top: 0;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 主内容区域 */
        .main-content {
            padding-top: 0;
            min-height: calc(100vh - 200px);
        }
        
        /* 可访问性增强 */
        a:focus-visible, 
        button:focus-visible, 
        select:focus-visible, 
        input:focus-visible, 
        textarea:focus-visible {
            outline: 3px solid #2563eb;
            outline-offset: 2px;
            border-radius: .375rem;
        }
        
        /* 加载动画 */
        .loading {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 表格斑马纹 */
        .table-striped tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        /* 页面切换动画 */
        .page-transition {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .page.active .page-transition {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 统计卡片优化 */
        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 照片预览样式 */
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
        
        .photo-upload {
            position: relative;
            display: inline-block;
        }
        
        .photo-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        /* VTS履历样式 */
        .vts-history-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: #f9fafb;
        }
        
        .vts-history-item:hover {
            background: #f3f4f6;
        }
        
        /* 数据验证提示 */
        .validation-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        .validation-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        /* 改进的状态指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .responsive-table {
                font-size: 0.875rem;
            }
            .responsive-table th,
            .responsive-table td {
                padding: 0.5rem 0.25rem;
            }
            
            .main-content {
                padding: 0.5rem;
            }
            
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 640px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- 登录页面 -->
    <div id="loginPage" class="page active min-h-screen flex items-center justify-center">
        <div class="page-transition max-w-md w-full mx-4">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">海事局VTS系统</h1>
                    <p class="text-gray-600 mt-2">请登录您的账号</p>
                </div>
                
                <form id="loginForm" class="space-y-6" role="form" aria-labelledby="loginTitle">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                        <input type="text" id="loginUsername" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               aria-describedby="loginUsernameHelp">
                    </div>
                    
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="loginPassword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="loginOrganization" class="block text-sm font-medium text-gray-700 mb-2">单位</label>
                        <select id="loginOrganization" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">请选择单位</option>
                            <option value="省厅">山东海事局</option>
                            <option value="烟台分局">烟台海事局</option>
                            <option value="青岛分局">青岛海事局</option>
                            <option value="威海分局">威海海事局</option>
                            <option value="日照分局">日照海事局</option>
                            <option value="东营分局">东营海事局</option>
                            <option value="潍坊分局">潍坊海事局</option>
                            <option value="董家口分局">董家口海事局</option>
                            <option value="滨州分局">滨州海事局</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        登录
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <button onclick="showRegisterForm()" 
                            class="text-blue-600 hover:text-blue-800 text-sm focus:outline-none focus:underline">
                        还没有账号？点击注册
                    </button>
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">测试账号</h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <div><strong>管理员:</strong> admin / 123456</div>
                        <div><strong>普通用户:</strong> user / 123456</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册页面 -->
    <div id="registerPage" class="page min-h-screen flex items-center justify-center">
        <div class="page-transition max-w-md w-full mx-4">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">用户注册</h1>
                    <p class="text-gray-600 mt-2">创建您的账号</p>
                </div>
                
                <form id="registerForm" class="space-y-4" role="form">
                    <div>
                        <label for="regUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="regUsername" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="regUsernameError" class="validation-message hidden"></div>
                    </div>
                    
                    <div>
                        <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="regPassword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="regPasswordError" class="validation-message hidden"></div>
                    </div>
                    
                    <div>
                        <label for="regPasswordConfirm" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                        <input type="password" id="regPasswordConfirm" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="regPasswordConfirmError" class="validation-message hidden"></div>
                    </div>
                    
                    <div>
                        <label for="regRealName" class="block text-sm font-medium text-gray-700 mb-1">真实姓名</label>
                        <input type="text" id="regRealName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="regRealNameError" class="validation-message hidden"></div>
                    </div>
                    
                    <div>
                        <label for="regOrganization" class="block text-sm font-medium text-gray-700 mb-1">所属单位</label>
                        <select id="regOrganization" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">请选择单位</option>
                            <option value="省厅">山东海事局</option>
                            <option value="烟台分局">烟台海事局</option>
                            <option value="青岛分局">青岛海事局</option>
                            <option value="威海分局">威海海事局</option>
                            <option value="日照分局">日照海事局</option>
                            <option value="东营分局">东营海事局</option>
                            <option value="潍坊分局">潍坊海事局</option>
                            <option value="董家口分局">董家口海事局</option>
                            <option value="滨州分局">滨州海事局</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="regUserType" class="block text-sm font-medium text-gray-700 mb-1">用户类型</label>
                        <select id="regUserType" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">管理员需要上级审核批准</p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-200 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        注册
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <button onclick="showLoginForm()" 
                            class="text-blue-600 hover:text-blue-800 text-sm focus:outline-none focus:underline">
                        已有账号？返回登录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主系统页面 -->
    <div id="mainPage" class="page">
        <div class="page-transition">
            <!-- 头部导航 -->
            <div class="main-header bg-blue-900 text-white p-4 md:p-6">
                <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center">
                    <div class="mb-2 sm:mb-0">
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold mb-2">海事局VTS值班人事管理系统</h1>
                        <p class="text-blue-100 text-sm md:text-base">Maritime Safety Administration VTS Human Resource Management System</p>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right">
                            <div class="font-medium text-sm md:text-base" id="currentUserName">未登录</div>
                            <div class="text-xs md:text-sm text-blue-200" id="currentUserOrg">-</div>
                            <div class="text-xs text-blue-300" id="currentUserRole">-</div>
                        </div>
                        <button onclick="showUserManagement()" id="userManagementBtn" 
                                class="hidden bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-200 px-3 py-2 rounded-lg text-xs md:text-sm transition-colors">
                            用户管理
                        </button>
                        <button onclick="logout()" 
                                class="bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-200 px-3 py-2 rounded-lg text-xs md:text-sm transition-colors">
                            退出登录
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-content max-w-7xl mx-auto p-2 md:p-4">
                <!-- 统计卡片 -->
                <div class="stat-grid grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-6 mb-4 md:mb-6">
                    <div class="stat-card bg-white rounded-lg shadow p-3 md:p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 md:h-8 md:w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <div class="ml-2 md:ml-4">
                                <p class="text-xs md:text-sm font-medium text-gray-600">总人数</p>
                                <p class="text-lg md:text-2xl font-semibold text-gray-900" id="totalCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow p-3 md:p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 md:h-8 md:w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="ml-2 md:ml-4">
                                <p class="text-xs md:text-sm font-medium text-gray-600">VTS在岗</p>
                                <p class="text-lg md:text-2xl font-semibold text-gray-900" id="onDutyCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow p-3 md:p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 md:h-8 md:w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <div class="ml-2 md:ml-4">
                                <p class="text-xs md:text-sm font-medium text-gray-600">值班长</p>
                                <p class="text-lg md:text-2xl font-semibold text-gray-900" id="supervisorCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow p-3 md:p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 md:h-8 md:w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                            </svg>
                            <div class="ml-2 md:ml-4">
                                <p class="text-xs md:text-sm font-medium text-gray-600">持证人员</p>
                                <p class="text-lg md:text-2xl font-semibold text-gray-900" id="certifiedCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow p-3 md:p-6 hover:shadow-md transition-shadow col-span-2 sm:col-span-1">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 md:h-8 md:w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="ml-2 md:ml-4">
                                <p class="text-xs md:text-sm font-medium text-gray-600">累计履历</p>
                                <p class="text-lg md:text-2xl font-semibold text-gray-900" id="monthlyDutyDays">0</p>
                                <p class="text-xs text-gray-500">天数</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选区域 -->
                <div class="bg-white rounded-lg shadow p-4 md:p-6 mb-4 md:mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-4">
                        <div class="relative lg:col-span-2">
                            <input type="text" id="searchInput" 
                                   placeholder="搜索姓名、单位..."
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   aria-label="搜索员工信息">
                            <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <select id="unitFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">所有单位</option>
                        </select>
                        
                        <select id="roleFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">所有身份</option>
                            <option value="值班长">值班长</option>
                            <option value="值班员">值班员</option>
                            <option value="见习">见习</option>
                            <option value="协管">协管</option>
                        </select>
                        
                        <select id="statusFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">工作状态</option>
                            <option value="VTS在岗">VTS在岗</option>
                            <option value="海事处">海事处</option>
                            <option value="机关">机关</option>
                        </select>
                        
                        <select id="certificateFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">证书情况</option>
                            <option value="有证书">有证书</option>
                            <option value="无证书">无证书</option>
                            <option value="船长">船长</option>
                            <option value="大副">大副</option>
                            <option value="二副">二副</option>
                            <option value="三副">三副</option>
                            <option value="轮机长">轮机长</option>
                            <option value="大管轮">大管轮</option>
                            <option value="二管轮">二管轮</option>
                            <option value="三管轮">三管轮</option>
                            <option value="电机员">电机员</option>
                        </select>
                        
                        <select id="educationFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">所有学历</option>
                            <option value="大专">大专</option>
                            <option value="本科">本科</option>
                            <option value="研究生及以上">研究生及以上</option>
                        </select>
                        
                        <button onclick="showAddModal()" id="addEmployeeBtn" 
                                class="bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white px-4 py-2 rounded-lg hidden transition-colors">
                            添加员工
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="exportToCSV()" 
                                    class="bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-200 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                导出CSV
                            </button>
                            <button onclick="showDutySchedule()" 
                                    class="bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-200 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                履历日历
                            </button>
                            <button onclick="showDutyAnalysis()" 
                                    class="bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:ring-purple-200 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                履历分析
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button onclick="showBulkActions()" id="bulkActionsBtn" 
                                    class="bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:ring-orange-200 text-white px-4 py-2 rounded-lg text-sm hidden transition-colors">
                                批量操作
                            </button>
                            <button onclick="resetToDefaultData()" id="resetDataBtn" 
                                    class="bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-200 text-white px-4 py-2 rounded-lg text-sm hidden transition-colors">
                                重置数据
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 员工列表 -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 responsive-table table-striped">
                            <caption class="sr-only">VTS员工信息列表</caption>
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" 
                                               class="mr-2" aria-label="全选员工">
                                        员工信息
                                    </th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单位职务</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">工作状态</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VTS履历</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书情况</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系方式</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTable" class="bg-white divide-y divide-gray-200">
                                <!-- 员工数据将由JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div id="paginationContainer" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button id="prevPageMobile" 
                                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                上一页
                            </button>
                            <button id="nextPageMobile" 
                                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                下一页
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    显示第 <span id="startItem" class="font-medium">1</span> 到 
                                    <span id="endItem" class="font-medium">10</span> 条，
                                    共 <span id="totalItems" class="font-medium">0</span> 条记录
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="分页">
                                    <button id="prevPage" 
                                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                        <span class="sr-only">上一页</span>
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                    
                                    <div id="pageNumbers" class="flex">
                                        <!-- 页码按钮将由JavaScript生成 -->
                                    </div>
                                    
                                    <button id="nextPage" 
                                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                        <span class="sr-only">下一页</span>
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 值班日历区域 -->
                <div id="calendarSection" class="mt-8 bg-white rounded-lg shadow p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">VTS履历日历</h3>
                        <button onclick="hideCalendar()" 
                                class="text-gray-400 hover:text-gray-600 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户管理页面 -->
    <div id="userManagementPage" class="page">
        <div class="page-transition">
            <div class="bg-blue-900 text-white p-6">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">用户管理</h1>
                        <p class="text-blue-100">User Management System</p>
                    </div>
                    <button onclick="backToMain()" 
                            class="bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-200 px-4 py-2 rounded-lg transition-colors">
                        返回主页
                    </button>
                </div>
            </div>

            <div class="max-w-7xl mx-auto p-6">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">系统用户列表</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <caption class="sr-only">系统用户管理表</caption>
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">真实姓名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所属单位</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户类型</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">注册时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="userTable" class="bg-white divide-y divide-gray-200">
                                <!-- 用户数据将由JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加员工模态框 -->
    <div id="addModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideAddModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-6xl w-full mx-auto z-10 max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="addModalTitle" class="text-lg font-medium text-gray-900">添加新员工</h3>
                </div>
                
                <form id="addEmployeeForm" class="px-6 py-4 space-y-6">
                    <!-- 基本信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">基本信息</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-start">
                            <!-- 照片上传区域 -->
                            <div class="flex flex-col items-center">
                                <label class="block text-sm font-medium text-gray-700 mb-2">照片</label>
                                <div class="photo-upload">
                                    <img id="newPhotoPreview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMTIgMTJDMTQgMTIgMTYgMTAgMTYgOEMxNiA2IDE0IDQgMTIgNEMxMCA0IDggNiA4IDhDOCAxMCAxMCAxMiAxMiAxMloiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTIwIDIwVjE2QzIwIDEyIDEyIDEyIDEyIDEyUzQgMTIgNCAxNlYyMEgyMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=" class="photo-preview" alt="照片预览">
                                    <input type="file" id="newPhoto" accept="image/*" onchange="previewPhoto('new')">
                                </div>
                                <button type="button" onclick="clearPhoto('new')" class="mt-2 text-sm text-red-600 hover:text-red-800">清除照片</button>
                            </div>
                            
                            <!-- 基本信息字段 -->
                            <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label for="newName" class="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
                                    <input type="text" id="newName" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <div id="newNameError" class="validation-message hidden"></div>
                                </div>
                                <div>
                                    <label for="newGender" class="block text-sm font-medium text-gray-700 mb-1">性别</label>
                                    <select id="newGender" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="newBirthDate" class="block text-sm font-medium text-gray-700 mb-1">出生日期</label>
                                    <input type="date" id="newBirthDate" onchange="calculateAge('new')"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="newAge" class="block text-sm font-medium text-gray-700 mb-1">年龄</label>
                                    <input type="number" id="newAge" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label for="newEducation" class="block text-sm font-medium text-gray-700 mb-1">学历</label>
                                    <select id="newEducation" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="大专">大专</option>
                                        <option value="本科">本科</option>
                                        <option value="研究生及以上">研究生及以上</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="newUniversity" class="block text-sm font-medium text-gray-700 mb-1">毕业院校</label>
                                    <input type="text" id="newUniversity"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="newMajor" class="block text-sm font-medium text-gray-700 mb-1">专业</label>
                                    <input type="text" id="newMajor"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="newMaritimeExperience" class="block text-sm font-medium text-gray-700 mb-1">涉海经历</label>
                            <textarea id="newMaritimeExperience" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="请描述涉海工作经历、船舶服务经历等"></textarea>
                        </div>
                    </div>

                    <!-- 证书信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">证书信息</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertCaptain" class="mr-2">
                                <label for="newCertCaptain" class="text-sm text-gray-700">船长</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertChiefOfficer" class="mr-2">
                                <label for="newCertChiefOfficer" class="text-sm text-gray-700">大副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertSecondOfficer" class="mr-2">
                                <label for="newCertSecondOfficer" class="text-sm text-gray-700">二副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertThirdOfficer" class="mr-2">
                                <label for="newCertThirdOfficer" class="text-sm text-gray-700">三副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertChiefEngineer" class="mr-2">
                                <label for="newCertChiefEngineer" class="text-sm text-gray-700">轮机长</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertFirstEngineer" class="mr-2">
                                <label for="newCertFirstEngineer" class="text-sm text-gray-700">大管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertSecondEngineer" class="mr-2">
                                <label for="newCertSecondEngineer" class="text-sm text-gray-700">二管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertThirdEngineer" class="mr-2">
                                <label for="newCertThirdEngineer" class="text-sm text-gray-700">三管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="newCertElectrician" class="mr-2">
                                <label for="newCertElectrician" class="text-sm text-gray-700">电机员</label>
                            </div>
                        </div>
                    </div>

                    <!-- 工作信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">工作信息</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="newUnit" class="block text-sm font-medium text-gray-700 mb-1">单位</label>
                                <input type="text" id="newUnit" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="newRole" class="block text-sm font-medium text-gray-700 mb-1">身份</label>
                                <select id="newRole" onchange="handleRoleChange('new')"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="值班长">值班长</option>
                                    <option value="值班员">值班员</option>
                                    <option value="见习">见习</option>
                                    <option value="协管">协管</option>
                                </select>
                            </div>
                            <div>
                                <label for="newWorkStatus" class="block text-sm font-medium text-gray-700 mb-1">工作状态</label>
                                <select id="newWorkStatus" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="VTS在岗">VTS在岗</option>
                                    <option value="海事处">海事处</option>
                                    <option value="机关">机关</option>
                                </select>
                            </div>
                            <div>
                                <label for="newHireDate" class="block text-sm font-medium text-gray-700 mb-1">入职时间</label>
                                <input type="date" id="newHireDate"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- VTS履历 -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">VTS履历</label>
                                <button type="button" onclick="addVTSHistory('new')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    添加履历
                                </button>
                            </div>
                            <div id="newVTSHistoryContainer" class="space-y-2">
                                <!-- VTS履历项将动态添加 -->
                            </div>
                        </div>
                        
                        <!-- 培训记录 -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">培训记录</label>
                                <button type="button" onclick="addTrainingRecord('new')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    添加培训
                                </button>
                            </div>
                            <div id="newTrainingContainer" class="space-y-2">
                                <!-- 培训记录将动态添加 -->
                            </div>
                        </div>
                    </div>

                    <!-- 联系信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">联系信息</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="newPhone" class="block text-sm font-medium text-gray-700 mb-1">电话</label>
                                <input type="tel" id="newPhone" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <div id="newPhoneError" class="validation-message hidden"></div>
                            </div>
                            <div>
                                <label for="newEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                                <input type="email" id="newEmail" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <div id="newEmailError" class="validation-message hidden"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 工作绩效信息 -->
                    <div>
                        <h4 class="text-md font-medium text-gray-700 mb-3">工作绩效</h4>
                        <div>
                            <label for="newPerformance" class="block text-sm font-medium text-gray-700 mb-1">比武获奖、特殊工作经历、履约提案、课题论文等</label>
                            <textarea id="newPerformance" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="请详细描述工作绩效，包括比武获奖情况、特殊工作经历、履约提案、课题论文、荣誉表彰等"></textarea>
                        </div>
                    </div>
                </form>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="hideAddModal()" 
                            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 rounded-lg transition-colors">
                        取消
                    </button>
                    <button type="button" onclick="addEmployee()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white rounded-lg transition-colors">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看详情模态框 -->
    <div id="viewModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideViewModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-6xl w-full mx-auto z-10">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 id="viewModalTitle" class="text-lg font-medium text-gray-900">员工详细信息</h3>
                    <button onclick="hideViewModal()" 
                            class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="px-6 py-6 max-h-96 overflow-y-auto" id="employeeDetails">
                    <!-- 员工详情将由JavaScript动态填充 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑员工模态框 -->
    <div id="editModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideEditModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-6xl w-full mx-auto z-10 max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="editModalTitle" class="text-lg font-medium text-gray-900">编辑员工信息</h3>
                </div>
                
                <form id="editEmployeeForm" class="px-6 py-4 space-y-6">
                    <!-- 基本信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">基本信息</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-start">
                            <!-- 照片上传区域 -->
                            <div class="flex flex-col items-center">
                                <label class="block text-sm font-medium text-gray-700 mb-2">照片</label>
                                <div class="photo-upload">
                                    <img id="editPhotoPreview" src="" class="photo-preview" alt="照片预览">
                                    <input type="file" id="editPhoto" accept="image/*" onchange="previewPhoto('edit')">
                                </div>
                                <button type="button" onclick="clearPhoto('edit')" class="mt-2 text-sm text-red-600 hover:text-red-800">清除照片</button>
                            </div>
                            
                            <!-- 基本信息字段 -->
                            <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label for="editName" class="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
                                    <input type="text" id="editName" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <div id="editNameError" class="validation-message hidden"></div>
                                </div>
                                <div>
                                    <label for="editGender" class="block text-sm font-medium text-gray-700 mb-1">性别</label>
                                    <select id="editGender" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="editBirthDate" class="block text-sm font-medium text-gray-700 mb-1">出生日期</label>
                                    <input type="date" id="editBirthDate" onchange="calculateAge('edit')"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="editAge" class="block text-sm font-medium text-gray-700 mb-1">年龄</label>
                                    <input type="number" id="editAge" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label for="editEducation" class="block text-sm font-medium text-gray-700 mb-1">学历</label>
                                    <select id="editEducation" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="大专">大专</option>
                                        <option value="本科">本科</option>
                                        <option value="研究生及以上">研究生及以上</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="editUniversity" class="block text-sm font-medium text-gray-700 mb-1">毕业院校</label>
                                    <input type="text" id="editUniversity"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="editMajor" class="block text-sm font-medium text-gray-700 mb-1">专业</label>
                                    <input type="text" id="editMajor"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="editMaritimeExperience" class="block text-sm font-medium text-gray-700 mb-1">涉海经历</label>
                            <textarea id="editMaritimeExperience" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="请描述涉海工作经历、船舶服务经历等"></textarea>
                        </div>
                    </div>

                    <!-- 证书信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">证书信息</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertCaptain" class="mr-2">
                                <label for="editCertCaptain" class="text-sm text-gray-700">船长</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertChiefOfficer" class="mr-2">
                                <label for="editCertChiefOfficer" class="text-sm text-gray-700">大副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertSecondOfficer" class="mr-2">
                                <label for="editCertSecondOfficer" class="text-sm text-gray-700">二副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertThirdOfficer" class="mr-2">
                                <label for="editCertThirdOfficer" class="text-sm text-gray-700">三副</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertChiefEngineer" class="mr-2">
                                <label for="editCertChiefEngineer" class="text-sm text-gray-700">轮机长</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertFirstEngineer" class="mr-2">
                                <label for="editCertFirstEngineer" class="text-sm text-gray-700">大管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertSecondEngineer" class="mr-2">
                                <label for="editCertSecondEngineer" class="text-sm text-gray-700">二管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertThirdEngineer" class="mr-2">
                                <label for="editCertThirdEngineer" class="text-sm text-gray-700">三管轮</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="editCertElectrician" class="mr-2">
                                <label for="editCertElectrician" class="text-sm text-gray-700">电机员</label>
                            </div>
                        </div>
                    </div>

                    <!-- 工作信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">工作信息</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="editUnit" class="block text-sm font-medium text-gray-700 mb-1">单位</label>
                                <input type="text" id="editUnit" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="editRole" class="block text-sm font-medium text-gray-700 mb-1">身份</label>
                                <select id="editRole" onchange="handleRoleChange('edit')"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="值班长">值班长</option>
                                    <option value="值班员">值班员</option>
                                    <option value="见习">见习</option>
                                    <option value="协管">协管</option>
                                </select>
                            </div>
                            <div>
                                <label for="editWorkStatus" class="block text-sm font-medium text-gray-700 mb-1">工作状态</label>
                                <select id="editWorkStatus" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="VTS在岗">VTS在岗</option>
                                    <option value="海事处">海事处</option>
                                    <option value="机关">机关</option>
                                </select>
                            </div>
                            <div>
                                <label for="editHireDate" class="block text-sm font-medium text-gray-700 mb-1">入职时间</label>
                                <input type="date" id="editHireDate"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- VTS履历 -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">VTS履历</label>
                                <button type="button" onclick="addVTSHistory('edit')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    添加履历
                                </button>
                            </div>
                            <div id="editVTSHistoryContainer" class="space-y-2">
                                <!-- VTS履历项将动态添加 -->
                            </div>
                        </div>
                        
                        <!-- 培训记录 -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">培训记录</label>
                                <button type="button" onclick="addTrainingRecord('edit')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    添加培训
                                </button>
                            </div>
                            <div id="editTrainingContainer" class="space-y-2">
                                <!-- 培训记录将动态添加 -->
                            </div>
                        </div>
                    </div>

                    <!-- 联系信息 -->
                    <div class="border-b pb-4">
                        <h4 class="text-md font-medium text-gray-700 mb-3">联系信息</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="editPhone" class="block text-sm font-medium text-gray-700 mb-1">电话</label>
                                <input type="tel" id="editPhone" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <div id="editPhoneError" class="validation-message hidden"></div>
                            </div>
                            <div>
                                <label for="editEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                                <input type="email" id="editEmail" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <div id="editEmailError" class="validation-message hidden"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 工作绩效信息 -->
                    <div>
                        <h4 class="text-md font-medium text-gray-700 mb-3">工作绩效</h4>
                        <div>
                            <label for="editPerformance" class="block text-sm font-medium text-gray-700 mb-1">比武获奖、特殊工作经历、履约提案、课题论文等</label>
                            <textarea id="editPerformance" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="请详细描述工作绩效，包括比武获奖情况、特殊工作经历、履约提案、课题论文、荣誉表彰等"></textarea>
                        </div>
                    </div>
                </form>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="hideEditModal()" 
                            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 rounded-lg transition-colors">
                        取消
                    </button>
                    <button type="button" onclick="saveEditEmployee()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white rounded-lg transition-colors">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 履历历史模态框 -->
    <div id="dutyHistoryModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="dutyHistoryModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideDutyHistoryModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full mx-auto z-10">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 id="dutyHistoryModalTitle" class="text-lg font-medium text-gray-900">VTS履历详情</h3>
                    <button onclick="hideDutyHistoryModal()" 
                            class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="px-6 py-6 max-h-96 overflow-y-auto" id="dutyHistoryContent">
                    <!-- VTS履历内容将由JavaScript动态填充 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 批量操作模态框 -->
    <div id="bulkModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="bulkModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideBulkModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full mx-auto z-10">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="bulkModalTitle" class="text-lg font-medium text-gray-900">批量操作 (<span id="selectedCount">0</span> 人已选择)</h3>
                </div>
                
                <div class="px-6 py-4 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="bulkDelete()" 
                                class="bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-200 text-white px-4 py-2 rounded-lg transition-colors">
                            批量删除
                        </button>
                        <button onclick="bulkChangeStatus()" 
                                class="bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white px-4 py-2 rounded-lg transition-colors">
                            批量修改工作状态
                        </button>
                        <button onclick="bulkExport()" 
                                class="bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-200 text-white px-4 py-2 rounded-lg transition-colors">
                            导出选中员工
                        </button>
                        <button onclick="addVTSRecord()" 
                                class="bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:ring-purple-200 text-white px-4 py-2 rounded-lg transition-colors">
                            添加VTS履历
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button onclick="hideBulkModal()" 
                            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 rounded-lg transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 履历分析模态框 -->
    <div id="analysisModal" class="modal fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="analysisModalTitle">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideAnalysisModal()" aria-hidden="true"></div>
            
            <div class="relative bg-white rounded-lg shadow-xl max-w-6xl w-full mx-auto z-10 max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 id="analysisModalTitle" class="text-lg font-medium text-gray-900">VTS履历分析报告</h3>
                    <button onclick="hideAnalysisModal()" 
                            class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="px-6 py-6" id="analysisContent">
                    <!-- 分析内容将由JavaScript动态填充 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingIndicator" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 hidden z-50">
        <div class="flex items-center space-x-3">
            <div class="loading"></div>
            <span class="text-gray-600">正在处理...</span>
        </div>
    </div>

    <script>
        /*********************
         * 全局变量与用户系统
         *********************/
        let currentUser = null;
        let users = [
            {
                id: 1,
                username: 'admin',
                password: '123456',
                realName: '系统管理员',
                organization: '省厅',
                userType: 'admin',
                status: 'active',
                registeredAt: '2024-01-01'
            },
            {
                id: 2,
                username: 'user',
                password: '123456',
                realName: '张三',
                organization: '青岛分局',
                userType: 'user',
                status: 'active',
                registeredAt: '2024-01-02'
            }
        ];

        // 员工数据按单位分组（优化后的数据结构）
        let employeesByOrganization = {
            '省厅': [
                {
                    id: 1, name: '王局长', gender: '男', birthDate: '1976-03-15',
                    unit: '山东海事局', role: '值班长', workStatus: 'VTS在岗',
                    phone: '13800001111', email: 'wang@sd.vts.msa.gov.cn',
                    certificates: ['船长', '大副'], education: '研究生及以上', 
                    university: '大连海事大学', major: '航海技术', maritimeExperience: '20年海事管理经验，曾任船长8年',
                    hireDate: '2010-03-15', photo: '',
                    vtsHistory: [
                        {startDate: '2010-03-15', endDate: '2015-06-30', position: '值班员', location: '青岛分局'},
                        {startDate: '2015-07-01', endDate: '2020-12-31', position: '值班长', location: '烟台分局'},
                        {startDate: '2021-01-01', endDate: '', position: '值班长', location: '山东海事局'}
                    ],
                    trainingRecords: [
                        {startDate: '2020-05-10', endDate: '2020-05-20', course: 'VTS高级管理培训', institution: '交通部海事局'},
                        {startDate: '2022-03-15', endDate: '2022-03-25', course: 'ECDIS系统培训', institution: '大连海事大学'}
                    ],
                    performance: '2023年荣获"优秀VTS管理者"称号，主导VTS系统升级项目，发表《现代VTS管理技术研究》论文，获得山东省科技进步三等奖。'
                },
                {
                    id: 2, name: '李副局长', gender: '男', birthDate: '1979-06-20',
                    unit: '山东海事局', role: '值班长', workStatus: 'VTS在岗',
                    phone: '13800001112', email: 'li@sd.vts.msa.gov.cn',
                    certificates: ['船长', '轮机长'], education: '研究生及以上',
                    university: '上海海事大学', major: '轮机工程', maritimeExperience: '18年海事工作经历，船舶服务12年',
                    hireDate: '2012-08-01', photo: '',
                    vtsHistory: [
                        {startDate: '2012-08-01', endDate: '2018-12-31', position: '值班员', location: '威海分局'},
                        {startDate: '2019-01-01', endDate: '', position: '值班长', location: '山东海事局'}
                    ],
                    trainingRecords: [
                        {startDate: '2021-09-01', endDate: '2021-09-10', course: '港口交通管理培训', institution: '中国海事局培训中心'}
                    ],
                    performance: '负责全省VTS协调工作，2022年全国VTS技能比武二等奖，参与制定《山东省VTS管理规范》标准。'
                }
            ],
            '青岛分局': [
                {
                    id: 3, name: '张伟', gender: '男', birthDate: '1989-03-15',
                    unit: '青岛海事局', role: '值班长', workStatus: 'VTS在岗',
                    phone: '13800138001', email: 'zhangwei@qd.vts.msa.gov.cn',
                    certificates: ['船长', '大副'], education: '本科', 
                    university: '青岛科技大学', major: '海洋技术', maritimeExperience: '10年VTS工作经验，5年船舶值班经历',
                    hireDate: '2014-07-01', photo: '',
                    vtsHistory: [
                        {startDate: '2014-07-01', endDate: '2018-06-30', position: '见习', location: '青岛海事局'},
                        {startDate: '2018-07-01', endDate: '2021-12-31', position: '值班员', location: '青岛海事局'},
                        {startDate: '2022-01-01', endDate: '', position: '值班长', location: '青岛海事局'}
                    ],
                    trainingRecords: [
                        {startDate: '2020-04-15', endDate: '2020-04-25', course: 'VTS操作员培训', institution: '青岛海事局'}
                    ],
                    performance: '青岛港区值班长，经验丰富。2023年青岛分局技能比武一等奖，多次获得月度优秀员工。'
                },
                {
                    id: 4, name: '李红', gender: '女', birthDate: '1996-07-01',
                    unit: '青岛海事局', role: '值班员', workStatus: 'VTS在岗',
                    phone: '13800138002', email: 'lihong@qd.vts.msa.gov.cn',
                    certificates: ['大副', '二副'], education: '本科',
                    university: '中国海洋大学', major: '港口航道与海岸工程', maritimeExperience: '6年海事工作经验',
                    hireDate: '2018-03-01', photo: '',
                    vtsHistory: [
                        {startDate: '2018-03-01', endDate: '2020-02-29', position: '见习', location: '青岛海事局'},
                        {startDate: '2020-03-01', endDate: '', position: '值班员', location: '青岛海事局'}
                    ],
                    trainingRecords: [],
                    performance: '青岛港VTS操作员，工作认真负责，连续两年获得优秀员工称号。'
                }
            ],
            '烟台分局': [],
            '威海分局': [],
            '日照分局': [],
            '东营分局': [],
            '潍坊分局': [],
            '董家口分局': [],
            '滨州分局': []
        };

        let employees = [];
        let filteredEmployees = [];
        let editingEmployeeId = null;
        let calendar = null;
        
        // 分页相关变量
        let currentPage = 1;
        const pageSize = 10;

        /*********************
         * 工具函数与验证
         *********************/
        
        // 验证函数
        function validateName(name) {
            if (!name || name.trim().length < 2) {
                return '姓名至少需要2个字符';
            }
            if (name.trim().length > 10) {
                return '姓名不能超过10个字符';
            }
            if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(name.trim())) {
                return '姓名只能包含中文、英文字母和空格';
            }
            return null;
        }

        function validatePhone(phone) {
            if (!phone) return null;
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                return '请输入正确的手机号格式';
            }
            return null;
        }

        function validateEmail(email) {
            if (!email) return null;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return '请输入正确的邮箱格式';
            }
            return null;
        }

        function validatePassword(password) {
            if (!password || password.length < 6) {
                return '密码长度不能少于6位';
            }
            if (password.length > 20) {
                return '密码长度不能超过20位';
            }
            return null;
        }

        function validateUsername(username) {
            if (!username || username.trim().length < 3) {
                return '用户名至少需要3个字符';
            }
            if (username.trim().length > 20) {
                return '用户名不能超过20个字符';
            }
            if (!/^[a-zA-Z0-9_]+$/.test(username.trim())) {
                return '用户名只能包含字母、数字和下划线';
            }
            return null;
        }

        function showValidationError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (field && errorDiv) {
                field.classList.add('validation-error');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function clearValidationError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (field && errorDiv) {
                field.classList.remove('validation-error');
                errorDiv.classList.add('hidden');
            }
        }

        function clearAllValidationErrors(prefix = '') {
            const errorIds = [
                prefix + 'NameError', 
                prefix + 'PhoneError', 
                prefix + 'EmailError',
                prefix + 'PasswordError',
                prefix + 'PasswordConfirmError',
                prefix + 'UsernameError',
                prefix + 'RealNameError'
            ];
            
            errorIds.forEach(id => {
                const errorDiv = document.getElementById(id);
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            });
            
            // 清除所有错误样式
            document.querySelectorAll('.validation-error').forEach(field => {
                field.classList.remove('validation-error');
            });
        }

        // 计算年龄函数
        function calculateAge(prefix) {
            const birthDateInput = document.getElementById(prefix + 'BirthDate');
            const ageInput = document.getElementById(prefix + 'Age');
            
            if (birthDateInput.value && ageInput) {
                const birthDate = new Date(birthDateInput.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                ageInput.value = age;
            }
        }

        // 根据出生日期计算年龄
        function calculateAgeFromBirthDate(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // 照片预览函数
        function previewPhoto(prefix) {
            const input = document.getElementById(prefix + 'Photo');
            const preview = document.getElementById(prefix + 'PhotoPreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // 验证文件大小（限制为2MB）
                if (file.size > 2 * 1024 * 1024) {
                    showToast('照片文件大小不能超过2MB', 'error');
                    input.value = '';
                    return;
                }
                
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    showToast('请选择有效的图片文件', 'error');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
        }

        // 清除照片
        function clearPhoto(prefix) {
            const input = document.getElementById(prefix + 'Photo');
            const preview = document.getElementById(prefix + 'PhotoPreview');
            
            input.value = '';
            if (prefix === 'new') {
                preview.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMTIgMTJDMTQgMTIgMTYgMTAgMTYgOEMxNiA2IDE0IDQgMTIgNEMxMCA0IDggNiA4IDhDOCAxMCAxMCAxMiAxMiAxMloiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTIwIDIwVjE2QzIwIDEyIDEyIDEyIDEyIDEyUzQgMTIgNCAxNlYyMEgyMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=";
            }
        }

        // 添加VTS履历
        function addVTSHistory(prefix) {
            const container = document.getElementById(prefix + 'VTSHistoryContainer');
            const index = container.children.length;
            
            const historyItem = document.createElement('div');
            historyItem.className = 'vts-history-item';
            historyItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="font-medium text-gray-700">VTS履历 ${index + 1}</h5>
                    <button type="button" onclick="removeVTSHistory(this)" 
                            class="text-red-600 hover:text-red-800 text-sm">删除</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">开始时间</label>
                        <input type="date" name="${prefix}VTSStartDate[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">结束时间</label>
                        <input type="date" name="${prefix}VTSEndDate[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">职务</label>
                        <select name="${prefix}VTSPosition[]" 
                                class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            <option value="见习">见习</option>
                            <option value="值班员">值班员</option>
                            <option value="值班长">值班长</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">工作地点</label>
                        <input type="text" name="${prefix}VTSLocation[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                               placeholder="如：青岛海事局">
                    </div>
                </div>
            `;
            
            container.appendChild(historyItem);
        }

        // 删除VTS履历
        function removeVTSHistory(button) {
            const historyItem = button.closest('.vts-history-item');
            historyItem.remove();
        }

        // 添加培训记录
        function addTrainingRecord(prefix) {
            const container = document.getElementById(prefix + 'TrainingContainer');
            const index = container.children.length;
            
            const trainingItem = document.createElement('div');
            trainingItem.className = 'vts-history-item';
            trainingItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="font-medium text-gray-700">培训记录 ${index + 1}</h5>
                    <button type="button" onclick="removeVTSHistory(this)" 
                            class="text-red-600 hover:text-red-800 text-sm">删除</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">开始时间</label>
                        <input type="date" name="${prefix}TrainingStartDate[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">结束时间</label>
                        <input type="date" name="${prefix}TrainingEndDate[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">培训机构</label>
                        <input type="text" name="${prefix}TrainingInstitution[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                               placeholder="如：交通部海事局">
                    </div>
                    <div class="sm:col-span-2 lg:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">培训课程</label>
                        <input type="text" name="${prefix}TrainingCourse[]" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                               placeholder="如：VTS高级操作培训">
                    </div>
                </div>
            `;
            
            container.appendChild(trainingItem);
        }
        
        // 防抖函数
        function debounce(fn, delay = 300) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // 显示加载指示器
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        // 隐藏加载指示器
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // 显示提示信息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        /*********************
         * VTS履历天数计算
         *********************/
        
        // 计算VTS履历总天数
        function calculateDutyDays(vtsHistory) {
            if (!vtsHistory || vtsHistory.length === 0) return 0;
            
            let totalDays = 0;
            const today = new Date();
            
            vtsHistory.forEach(history => {
                if (history.startDate) {
                    const startDate = new Date(history.startDate);
                    const endDate = history.endDate ? new Date(history.endDate) : today;
                    
                    // 计算天数差
                    const timeDiff = endDate.getTime() - startDate.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    if (daysDiff > 0) {
                        totalDays += daysDiff;
                    }
                }
            });
            
            return totalDays;
        }

        /*********************
         * 页面切换函数
         *********************/
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                if (pageId === 'loginPage' || pageId === 'registerPage') {
                    targetPage.style.display = 'flex';
                } else {
                    targetPage.style.display = 'block';
                }
                
                window.scrollTo({
                    top: 0,
                    left: 0,
                    behavior: 'instant'
                });
                
                setTimeout(() => {
                    document.documentElement.scrollTop = 0;
                    document.body.scrollTop = 0;
                }, 10);
            }
        }

        function showLoginForm() {
            clearAllValidationErrors('reg');
            showPage('loginPage');
        }

        function showRegisterForm() {
            clearAllValidationErrors('login');
            showPage('registerPage');
        }

        function showUserManagement() {
            showPage('userManagementPage');
            renderUserTable();
        }

        function backToMain() {
            showPage('mainPage');
        }

        /*********************
         * 登录注册功能
         *********************/
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const organization = document.getElementById('loginOrganization').value;
            
            if (!username || !password || !organization) {
                showToast('请填写完整的登录信息', 'error');
                return;
            }
            
            const user = users.find(u => 
                u.username === username && 
                u.password === password && 
                u.organization === organization &&
                u.status === 'active'
            );
            
            if (user) {
                currentUser = user;
                login(user);
            } else {
                showToast('用户名、密码或单位不正确！', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            clearAllValidationErrors('reg');
            
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const realName = document.getElementById('regRealName').value.trim();
            const organization = document.getElementById('regOrganization').value;
            const userType = document.getElementById('regUserType').value;
            
            let hasErrors = false;
            
            // 验证用户名
            const usernameError = validateUsername(username);
            if (usernameError) {
                showValidationError('regUsername', usernameError);
                hasErrors = true;
            } else if (users.find(u => u.username === username)) {
                showValidationError('regUsername', '用户名已存在');
                hasErrors = true;
            }
            
            // 验证密码
            const passwordError = validatePassword(password);
            if (passwordError) {
                showValidationError('regPassword', passwordError);
                hasErrors = true;
            }
            
            // 验证确认密码
            if (password !== passwordConfirm) {
                showValidationError('regPasswordConfirm', '两次输入的密码不一致');
                hasErrors = true;
            }
            
            // 验证真实姓名
            const realNameError = validateName(realName);
            if (realNameError) {
                showValidationError('regRealName', realNameError);
                hasErrors = true;
            }
            
            if (!organization) {
                showToast('请选择所属单位', 'error');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const newUser = {
                id: Math.max(...users.map(u => u.id)) + 1,
                username,
                password,
                realName,
                organization,
                userType,
                status: userType === 'admin' ? 'pending' : 'active',
                registeredAt: new Date().toISOString().split('T')[0]
            };
            
            users.push(newUser);
            saveToLocalStorage();
            
            if (userType === 'admin') {
                showToast('管理员账号注册成功，等待审核批准后方可使用！', 'success');
            } else {
                showToast('注册成功！现在可以登录了。', 'success');
            }
            
            showLoginForm();
            document.getElementById('registerForm').reset();
        });

        function login(user) {
            showLoading();
            
            document.getElementById('currentUserName').textContent = user.realName;
            document.getElementById('currentUserOrg').textContent = user.organization;
            document.getElementById('currentUserRole').textContent = user.userType === 'admin' ? '管理员' : '普通用户';
            
            if (user.userType === 'admin') {
                document.getElementById('addEmployeeBtn').classList.remove('hidden');
                document.getElementById('bulkActionsBtn').classList.remove('hidden');
                document.getElementById('resetDataBtn').classList.remove('hidden');
                document.getElementById('userManagementBtn').classList.remove('hidden');
                document.getElementById('selectAll').style.display = 'inline';
            } else {
                document.getElementById('addEmployeeBtn').classList.add('hidden');
                document.getElementById('bulkActionsBtn').classList.add('hidden');
                document.getElementById('resetDataBtn').classList.add('hidden');
                document.getElementById('userManagementBtn').classList.add('hidden');
                document.getElementById('selectAll').style.display = 'none';
            }
            
            setTimeout(() => {
                loadEmployeeData();
                showPage('mainPage');
                hideLoading();
                showToast('登录成功！', 'success');
                
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            }, 300);
        }

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                currentUser = null;
                employees = [];
                filteredEmployees = [];
                currentPage = 1;
                
                document.getElementById('calendarSection').classList.add('hidden');
                showPage('loginPage');
                document.getElementById('loginForm').reset();
                showToast('已安全退出登录', 'info');
            }
        }

        /*********************
         * 数据持久化存储
         *********************/
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    employeesByOrganization: employeesByOrganization,
                    users: users,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('vtsManagementSystem', JSON.stringify(dataToSave));
            } catch (e) {
                console.warn('无法保存数据到本地存储:', e);
                showToast('数据保存失败，请检查浏览器存储权限', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('vtsManagementSystem');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.employeesByOrganization) {
                        employeesByOrganization = data.employeesByOrganization;
                    }
                    if (data.users) {
                        users = data.users;
                    }
                    return true;
                }
            } catch (e) {
                console.warn('无法从本地存储加载数据:', e);
                showToast('数据加载失败，将使用默认数据', 'warning');
            }
            return false;
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem('vtsManagementSystem');
                showToast('本地存储已清除！', 'info');
            } catch (e) {
                console.warn('无法清除本地存储:', e);
            }
        }

        /*********************
         * 数据加载与管理
         *********************/
        function loadEmployeeData() {
            if (!currentUser) return;
            
            if (currentUser.organization === '省厅') {
                employees = [];
                Object.values(employeesByOrganization).forEach(orgEmployees => {
                    employees.push(...orgEmployees);
                });
            } else {
                employees = employeesByOrganization[currentUser.organization] || [];
            }
            
            // 确保每个员工都有计算好的履历天数
            employees.forEach(emp => {
                if (!emp.dutyDays) {
                    emp.dutyDays = calculateDutyDays(emp.vtsHistory);
                }
            });
            
            filteredEmployees = [...employees];
            currentPage = 1;
            renderEmployeeTable();
            updateFilters();
            updateStats();
        }

        function renderUserTable() {
            const tbody = document.getElementById('userTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = user.status === 'active' ? '正常' : '待审核';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.realName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.organization}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-indicator ${user.userType === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.userType === 'admin' ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-indicator ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.registeredAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${user.status === 'pending' ? 
                            `<button onclick="approveUser(${user.id})" class="text-green-600 hover:text-green-900 mr-2 focus:outline-none focus:underline">批准</button>
                             <button onclick="rejectUser(${user.id})" class="text-red-600 hover:text-red-900 focus:outline-none focus:underline">拒绝</button>` :
                            `<button onclick="toggleUserStatus(${user.id})" class="text-gray-600 hover:text-gray-900 focus:outline-none focus:underline">
                                ${user.status === 'active' ? '禁用' : '启用'}
                             </button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function approveUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = 'active';
                saveToLocalStorage();
                showToast(`用户 ${user.realName} 已批准！`, 'success');
                renderUserTable();
            }
        }

        function rejectUser(userId) {
            if (confirm('确定要拒绝这个用户的注册申请吗？')) {
                const user = users.find(u => u.id === userId);
                users = users.filter(u => u.id !== userId);
                saveToLocalStorage();
                renderUserTable();
                showToast('用户申请已拒绝', 'info');
            }
        }

        function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (user && confirm(`确定要${user.status === 'active' ? '禁用' : '启用'}这个用户吗？`)) {
                user.status = user.status === 'active' ? 'disabled' : 'active';
                saveToLocalStorage();
                renderUserTable();
                showToast(`用户状态已${user.status === 'active' ? '启用' : '禁用'}`, 'info');
            }
        }

        /*********************
         * 员工管理功能
         *********************/

        // 身份变化处理（优化工作状态逻辑）
        function handleRoleChange(prefix) {
            const roleSelect = document.getElementById(prefix + 'Role');
            const workStatusSelect = document.getElementById(prefix + 'WorkStatus');
            
            if (roleSelect && workStatusSelect) {
                // 见习和协管人员默认只能是VTS在岗状态
                if (roleSelect.value === '见习' || roleSelect.value === '协管') {
                    workStatusSelect.value = 'VTS在岗';
                    // 移除限制，允许管理员灵活调整
                    // workStatusSelect.disabled = true;
                } else {
                    workStatusSelect.disabled = false;
                }
            }
        }

        // 获取身份颜色
        function getRoleColor(role) {
            switch(role) {
                case '值班长': return 'bg-red-100 text-red-800';
                case '值班员': return 'bg-blue-100 text-blue-800';
                case '见习': return 'bg-green-100 text-green-800';
                case '协管': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // 获取工作状态颜色
        function getWorkStatusColor(status) {
            switch(status) {
                case 'VTS在岗': return 'bg-green-100 text-green-800';
                case '海事处': return 'bg-blue-100 text-blue-800';
                case '机关': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // 渲染员工表格（带分页）
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const totalItems = filteredEmployees.length;
            const totalPages = Math.ceil(totalItems / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalItems);
            const pageEmployees = filteredEmployees.slice(startIndex, endIndex);
            
            pageEmployees.forEach(emp => {
                const dutyDays = emp.dutyDays || calculateDutyDays(emp.vtsHistory);
                const certCount = emp.certificates ? emp.certificates.length : 0;
                const vtsHistoryCount = emp.vtsHistory ? emp.vtsHistory.length : 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const isAdmin = currentUser && currentUser.userType === 'admin';
                const actionButtons = isAdmin ? `
                    <button onclick="viewEmployee(${emp.id})" 
                            class="text-blue-600 hover:text-blue-900 mr-2 focus:outline-none focus:underline" 
                            title="查看详情" aria-label="查看 ${emp.name} 的详情">
                        查看
                    </button>
                    <button onclick="editEmployee(${emp.id})" 
                            class="text-indigo-600 hover:text-indigo-900 mr-2 focus:outline-none focus:underline" 
                            title="编辑信息" aria-label="编辑 ${emp.name} 的信息">
                        编辑
                    </button>
                    <button onclick="deleteEmployee(${emp.id})" 
                            class="text-red-600 hover:text-red-900 focus:outline-none focus:underline" 
                            title="删除员工" aria-label="删除员工 ${emp.name}">
                        删除
                    </button>
                ` : `
                    <button onclick="viewEmployee(${emp.id})" 
                            class="text-blue-600 hover:text-blue-900 focus:outline-none focus:underline" 
                            title="查看详情" aria-label="查看 ${emp.name} 的详情">
                        查看
                    </button>
                `;

                const checkboxColumn = isAdmin ? 
                    `<input type="checkbox" class="employee-checkbox mr-3" value="${emp.id}" aria-label="选择 ${emp.name}">` : 
                    '<span class="mr-3"></span>';
                
                // 显示员工照片或默认头像
                const photoDisplay = emp.photo ? 
                    `<img src="${emp.photo}" class="h-8 w-8 md:h-10 md:w-10 rounded-full object-cover border-2 border-gray-200" alt="${emp.name}">` :
                    `<div class="h-8 w-8 md:h-10 md:w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium text-sm" aria-hidden="true">${emp.name.charAt(0)}</div>`;
                
                row.innerHTML = `
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${checkboxColumn}
                            ${photoDisplay}
                            <div class="ml-2 md:ml-4">
                                <div class="text-sm font-medium text-gray-900">${emp.name}</div>
                                <div class="text-xs text-gray-500">${emp.gender} | ${emp.birthDate ? calculateAgeFromBirthDate(emp.birthDate) : 'N/A'}岁 | ${emp.education}</div>
                                ${emp.university ? `<div class="text-xs text-gray-400">${emp.university}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm text-gray-900">${emp.unit.length > 15 ? emp.unit.substring(0, 12) + '...' : emp.unit}</div>
                        <span class="status-indicator ${getRoleColor(emp.role)}">
                            ${emp.role}
                        </span>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <span class="status-indicator ${getWorkStatusColor(emp.workStatus)}">
                            ${emp.workStatus}
                        </span>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm text-gray-900">${vtsHistoryCount}条履历</div>
                        <div class="text-xs text-gray-500">${dutyDays}天经历</div>
                        <button onclick="showDutyHistory(${emp.id})" 
                                class="text-blue-600 hover:text-blue-900 text-xs focus:outline-none focus:underline"
                                aria-label="查看 ${emp.name} 的履历详情">
                            查看详情
                        </button>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm text-gray-900">${certCount}个证书</div>
                        <div class="text-xs text-gray-500">
                            ${emp.certificates && emp.certificates.length > 0 ? 
                                emp.certificates.slice(0, 2).join(', ') + (emp.certificates.length > 2 ? '...' : '') : 
                                '暂无证书'
                            }
                        </div>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm text-gray-900">${emp.phone || '-'}</div>
                        <div class="text-xs text-gray-500">${emp.email || '-'}</div>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex flex-col space-y-1">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updatePagination(totalItems, totalPages);
        }

        // 更新分页控件
        function updatePagination(totalItems, totalPages) {
            const startItem = totalItems > 0 ? ((currentPage - 1) * pageSize) + 1 : 0;
            const endItem = Math.min(currentPage * pageSize, totalItems);
            
            document.getElementById('startItem').textContent = startItem;
            document.getElementById('endItem').textContent = endItem;
            document.getElementById('totalItems').textContent = totalItems;
            
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const prevPageMobileBtn = document.getElementById('prevPageMobile');
            const nextPageMobileBtn = document.getElementById('nextPageMobile');
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            prevPageMobileBtn.disabled = currentPage === 1;
            nextPageMobileBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === currentPage 
                        ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' 
                        : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
            
            prevPageBtn.onclick = () => goToPage(currentPage - 1);
            nextPageBtn.onclick = () => goToPage(currentPage + 1);
            prevPageMobileBtn.onclick = () => goToPage(currentPage - 1);
            nextPageMobileBtn.onclick = () => goToPage(currentPage + 1);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredEmployees.length / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderEmployeeTable();
                const table = document.querySelector('.responsive-table');
                if (table) {
                    table.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }

        // 更新筛选选项
        function updateFilters() {
            const units = [...new Set(employees.map(emp => emp.unit))];
            
            const unitFilter = document.getElementById('unitFilter');
            if (unitFilter) {
                unitFilter.innerHTML = '<option value="">所有单位</option>';
                units.forEach(unit => {
                    unitFilter.innerHTML += `<option value="${unit}">${unit}</option>`;
                });
            }
        }

        // 更新统计数据
        function updateStats() {
            const elements = {
                totalCount: employees.length,
                onDutyCount: employees.filter(emp => emp.workStatus === 'VTS在岗').length,
                supervisorCount: employees.filter(emp => emp.role === '值班长').length,
                certifiedCount: employees.filter(emp => emp.certificates && emp.certificates.length > 0).length,
                monthlyDutyDays: employees.reduce((sum, emp) => sum + (emp.dutyDays || calculateDutyDays(emp.vtsHistory)), 0)
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    const currentValue = parseInt(element.textContent) || 0;
                    if (currentValue !== value) {
                        animateNumber(element, currentValue, value);
                    }
                }
            });
        }

        // 数字动画效果
        function animateNumber(element, start, end, duration = 1000) {
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // 搜索和筛选（带防抖）
        const debouncedFilter = debounce(function() {
            const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const unit = document.getElementById('unitFilter')?.value || '';
            const role = document.getElementById('roleFilter')?.value || '';
            const status = document.getElementById('statusFilter')?.value || '';
            const certificateFilter = document.getElementById('certificateFilter')?.value || '';
            const education = document.getElementById('educationFilter')?.value || '';
            
            filteredEmployees = employees.filter(emp => {
                const matchesSearch = emp.name.toLowerCase().includes(search) ||
                                    emp.unit.toLowerCase().includes(search) ||
                                    (emp.phone && emp.phone.includes(search)) ||
                                    (emp.email && emp.email.toLowerCase().includes(search)) ||
                                    (emp.performance && emp.performance.toLowerCase().includes(search)) ||
                                    (emp.university && emp.university.toLowerCase().includes(search)) ||
                                    (emp.major && emp.major.toLowerCase().includes(search));
                
                const matchesUnit = !unit || emp.unit === unit;
                const matchesRole = !role || emp.role === role;
                const matchesStatus = !status || emp.workStatus === status;
                const matchesEducation = !education || emp.education === education;
                
                let matchesCertificate = true;
                if (certificateFilter) {
                    const empCertificates = emp.certificates || [];
                    if (certificateFilter === '有证书') {
                        matchesCertificate = empCertificates.length > 0;
                    } else if (certificateFilter === '无证书') {
                        matchesCertificate = empCertificates.length === 0;
                    } else {
                        matchesCertificate = empCertificates.includes(certificateFilter);
                    }
                }
                
                return matchesSearch && matchesUnit && matchesRole && matchesStatus && matchesEducation && matchesCertificate;
            });
            
            currentPage = 1;
            renderEmployeeTable();
        }, 300);

        /*********************
         * 员工详情与操作
         *********************/

        // 查看员工详情
        function viewEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const dutyDays = employee.dutyDays || calculateDutyDays(employee.vtsHistory);
            const vtsHistoryCount = employee.vtsHistory ? employee.vtsHistory.length : 0;
            const avgDaysPerPeriod = vtsHistoryCount > 0 ? Math.round((dutyDays / vtsHistoryCount) * 10) / 10 : 0;
            const currentAge = employee.birthDate ? calculateAgeFromBirthDate(employee.birthDate) : 'N/A';
            
            // 显示员工照片或默认头像
            const photoDisplay = employee.photo ? 
                `<img src="${employee.photo}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200" alt="${employee.name}">` :
                `<div class="w-24 h-24 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-2xl border-4 border-gray-200">${employee.name.charAt(0)}</div>`;
            
            // VTS履历展示
            const vtsHistoryDisplay = employee.vtsHistory && employee.vtsHistory.length > 0 ? 
                employee.vtsHistory.map(history => {
                    const startDate = history.startDate ? new Date(history.startDate) : null;
                    const endDate = history.endDate ? new Date(history.endDate) : new Date();
                    const days = startDate ? Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    return `
                        <div class="bg-gray-50 p-3 rounded-lg mb-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-gray-900">${history.position}</div>
                                    <div class="text-sm text-gray-600">${history.location}</div>
                                    <div class="text-xs text-blue-600 mt-1">${days > 0 ? days + '天' : ''}</div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${history.startDate} - ${history.endDate || '至今'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<div class="text-sm text-gray-400 italic">暂无VTS履历记录</div>';

            // 培训记录展示
            const trainingDisplay = employee.trainingRecords && employee.trainingRecords.length > 0 ? 
                employee.trainingRecords.map(training => `
                    <div class="bg-blue-50 p-3 rounded-lg mb-2">
                        <div class="font-medium text-blue-900">${training.course}</div>
                        <div class="text-sm text-blue-700">${training.institution}</div>
                        <div class="text-sm text-blue-600">
                            ${training.startDate} - ${training.endDate}
                        </div>
                    </div>
                `).join('') : '<div class="text-sm text-gray-400 italic">暂无培训记录</div>';
            
            const detailsContent = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 员工照片和基本信息 -->
                    <div class="lg:col-span-1">
                        <div class="text-center mb-6">
                            ${photoDisplay}
                            <h3 class="mt-4 text-xl font-bold text-gray-900">${employee.name}</h3>
                            <span class="status-indicator ${getRoleColor(employee.role)} mt-2">${employee.role}</span>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">基本信息</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">性别:</span>
                                    <span class="text-sm text-gray-900">${employee.gender}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">出生日期:</span>
                                    <span class="text-sm text-gray-900">${employee.birthDate || '未知'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">年龄:</span>
                                    <span class="text-sm text-gray-900">${currentAge}岁</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">学历:</span>
                                    <span class="text-sm text-gray-900">${employee.education || '未知'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">毕业院校:</span>
                                    <span class="text-sm text-gray-900">${employee.university || '未知'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">专业:</span>
                                    <span class="text-sm text-gray-900">${employee.major || '未知'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">入职时间:</span>
                                    <span class="text-sm text-gray-900">${employee.hireDate || '未知'}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 工作信息和履历 -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- 工作信息 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">工作信息</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-500">单位:</span>
                                    <div class="text-sm text-gray-900 mt-1">${employee.unit}</div>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">身份:</span>
                                    <div class="mt-1">
                                        <span class="status-indicator ${getRoleColor(employee.role)}">${employee.role}</span>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">工作状态:</span>
                                    <div class="mt-1">
                                        <span class="status-indicator ${getWorkStatusColor(employee.workStatus)}">${employee.workStatus}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 涉海经历 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">涉海经历</h4>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-800">${employee.maritimeExperience || '暂无涉海经历记录'}</p>
                            </div>
                        </div>

                        <!-- 证书情况 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">证书情况</h4>
                            <div class="flex flex-wrap gap-2">
                                ${employee.certificates && employee.certificates.length > 0 ? 
                                    employee.certificates.map(cert => 
                                        `<span class="status-indicator bg-blue-100 text-blue-800">${cert}</span>`
                                    ).join('') : 
                                    '<div class="text-sm text-gray-400 italic">暂无证书信息</div>'
                                }
                            </div>
                        </div>

                        <!-- VTS履历 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">VTS履历</h4>
                            ${vtsHistoryDisplay}
                        </div>

                        <!-- 培训记录 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">培训记录</h4>
                            ${trainingDisplay}
                        </div>

                        <!-- 履历统计 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">履历统计</h4>
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-900">${vtsHistoryCount}</div>
                                    <div class="text-sm text-blue-600">履历阶段数</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-900">${dutyDays}</div>
                                    <div class="text-sm text-green-600">累计天数</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-900">${avgDaysPerPeriod}</div>
                                    <div class="text-sm text-orange-600">平均每阶段(天)</div>
                                </div>
                            </div>
                            <button onclick="hideViewModal(); showDutyHistory(${employee.id})" 
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-200 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                查看详细VTS履历
                            </button>
                        </div>

                        <!-- 联系信息 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">联系信息</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-500">电话:</span>
                                    <div class="text-sm text-gray-900 mt-1">${employee.phone || '-'}</div>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">邮箱:</span>
                                    <div class="text-sm text-gray-900 mt-1">${employee.email || '-'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- 工作绩效 -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2 mb-4">工作绩效</h4>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="text-sm text-yellow-800">${employee.performance || '暂无工作绩效记录'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('employeeDetails').innerHTML = detailsContent;
            document.getElementById('viewModal').classList.add('show');
            
            setTimeout(() => {
                const modal = document.getElementById('viewModal');
                const firstFocusable = modal.querySelector('button');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }, 100);
        }

        function hideViewModal() {
            document.getElementById('viewModal').classList.remove('show');
        }

        // 编辑员工
        function editEmployee(id) {
            if (!currentUser || currentUser.userType !== 'admin') {
                showToast('没有权限执行此操作！', 'error');
                return;
            }
            
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            editingEmployeeId = id;
            clearAllValidationErrors('edit');
            
            // 填充基本信息
            document.getElementById('editName').value = employee.name;
            document.getElementById('editGender').value = employee.gender;
            document.getElementById('editBirthDate').value = employee.birthDate || '';
            document.getElementById('editAge').value = employee.birthDate ? calculateAgeFromBirthDate(employee.birthDate) : '';
            document.getElementById('editEducation').value = employee.education || '本科';
            document.getElementById('editUniversity').value = employee.university || '';
            document.getElementById('editMajor').value = employee.major || '';
            document.getElementById('editMaritimeExperience').value = employee.maritimeExperience || '';
            
            // 设置照片
            if (employee.photo) {
                document.getElementById('editPhotoPreview').src = employee.photo;
            } else {
                clearPhoto('edit');
            }
            
            // 填充证书信息
            const certCheckboxes = [
                { id: 'editCertCaptain', name: '船长' },
                { id: 'editCertChiefOfficer', name: '大副' },
                { id: 'editCertSecondOfficer', name: '二副' },
                { id: 'editCertThirdOfficer', name: '三副' },
                { id: 'editCertChiefEngineer', name: '轮机长' },
                { id: 'editCertFirstEngineer', name: '大管轮' },
                { id: 'editCertSecondEngineer', name: '二管轮' },
                { id: 'editCertThirdEngineer', name: '三管轮' },
                { id: 'editCertElectrician', name: '电机员' }
            ];
            
            certCheckboxes.forEach(cert => {
                const checkbox = document.getElementById(cert.id);
                if (checkbox) {
                    checkbox.checked = employee.certificates && employee.certificates.includes(cert.name);
                }
            });
            
            // 填充工作信息
            document.getElementById('editUnit').value = employee.unit;
            document.getElementById('editRole').value = employee.role;
            document.getElementById('editWorkStatus').value = employee.workStatus || 'VTS在岗';
            document.getElementById('editHireDate').value = employee.hireDate || '';
            
            // 填充VTS履历
            const vtsContainer = document.getElementById('editVTSHistoryContainer');
            vtsContainer.innerHTML = '';
            if (employee.vtsHistory && employee.vtsHistory.length > 0) {
                employee.vtsHistory.forEach((history, index) => {
                    addVTSHistory('edit');
                    const historyItems = vtsContainer.querySelectorAll('.vts-history-item');
                    const currentItem = historyItems[index];
                    if (currentItem) {
                        currentItem.querySelector('input[name="editVTSStartDate[]"]').value = history.startDate || '';
                        currentItem.querySelector('input[name="editVTSEndDate[]"]').value = history.endDate || '';
                        currentItem.querySelector('select[name="editVTSPosition[]"]').value = history.position || '';
                        currentItem.querySelector('input[name="editVTSLocation[]"]').value = history.location || '';
                    }
                });
            }
            
            // 填充培训记录
            const trainingContainer = document.getElementById('editTrainingContainer');
            trainingContainer.innerHTML = '';
            if (employee.trainingRecords && employee.trainingRecords.length > 0) {
                employee.trainingRecords.forEach((training, index) => {
                    addTrainingRecord('edit');
                    const trainingItems = trainingContainer.querySelectorAll('.vts-history-item');
                    const currentItem = trainingItems[index];
                    if (currentItem) {
                        currentItem.querySelector('input[name="editTrainingStartDate[]"]').value = training.startDate || '';
                        currentItem.querySelector('input[name="editTrainingEndDate[]"]').value = training.endDate || '';
                        currentItem.querySelector('input[name="editTrainingCourse[]"]').value = training.course || '';
                        currentItem.querySelector('input[name="editTrainingInstitution[]"]').value = training.institution || '';
                    }
                });
            }
            
            // 填充联系信息
            document.getElementById('editPhone').value = employee.phone || '';
            document.getElementById('editEmail').value = employee.email || '';
            document.getElementById('editPerformance').value = employee.performance || '';
            
            handleRoleChange('edit');
            
            document.getElementById('editModal').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('editName').focus();
            }, 100);
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('show');
            editingEmployeeId = null;
            clearAllValidationErrors('edit');
        }

        function saveEditEmployee() {
            if (!editingEmployeeId) return;
            
            clearAllValidationErrors('edit');
            
            const empIndex = employees.findIndex(emp => emp.id === editingEmployeeId);
            if (empIndex === -1) return;
            
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            
            let hasErrors = false;
            
            // 验证姓名
            const nameError = validateName(name);
            if (nameError) {
                showValidationError('editName', nameError);
                hasErrors = true;
            }
            
            // 验证电话
            const phoneError = validatePhone(phone);
            if (phoneError) {
                showValidationError('editPhone', phoneError);
                hasErrors = true;
            }
            
            // 验证邮箱
            const emailError = validateEmail(email);
            if (emailError) {
                showValidationError('editEmail', emailError);
                hasErrors = true;
            }
            
            if (hasErrors) return;

            // 获取证书
            const certificates = [];
            const certCheckboxes = [
                { id: 'editCertCaptain', name: '船长' },
                { id: 'editCertChiefOfficer', name: '大副' },
                { id: 'editCertSecondOfficer', name: '二副' },
                { id: 'editCertThirdOfficer', name: '三副' },
                { id: 'editCertChiefEngineer', name: '轮机长' },
                { id: 'editCertFirstEngineer', name: '大管轮' },
                { id: 'editCertSecondEngineer', name: '二管轮' },
                { id: 'editCertThirdEngineer', name: '三管轮' },
                { id: 'editCertElectrician', name: '电机员' }
            ];
            
            certCheckboxes.forEach(cert => {
                const checkbox = document.getElementById(cert.id);
                if (checkbox && checkbox.checked) {
                    certificates.push(cert.name);
                }
            });

            // 获取VTS履历
            const vtsHistory = [];
            const vtsContainer = document.getElementById('editVTSHistoryContainer');
            const vtsItems = vtsContainer.querySelectorAll('.vts-history-item');
            vtsItems.forEach(item => {
                const startDate = item.querySelector('input[name="editVTSStartDate[]"]').value;
                const endDate = item.querySelector('input[name="editVTSEndDate[]"]').value;
                const position = item.querySelector('select[name="editVTSPosition[]"]').value;
                const location = item.querySelector('input[name="editVTSLocation[]"]').value;
                
                if (startDate && position && location) {
                    vtsHistory.push({ startDate, endDate, position, location });
                }
            });

            // 获取培训记录
            const trainingRecords = [];
            const trainingContainer = document.getElementById('editTrainingContainer');
            const trainingItems = trainingContainer.querySelectorAll('.vts-history-item');
            trainingItems.forEach(item => {
                const startDate = item.querySelector('input[name="editTrainingStartDate[]"]').value;
                const endDate = item.querySelector('input[name="editTrainingEndDate[]"]').value;
                const course = item.querySelector('input[name="editTrainingCourse[]"]').value;
                const institution = item.querySelector('input[name="editTrainingInstitution[]"]').value;
                
                if (startDate && course && institution) {
                    trainingRecords.push({ startDate, endDate, course, institution });
                }
            });

            // 获取照片
            const photoPreview = document.getElementById('editPhotoPreview');
            const photo = photoPreview.src.startsWith('data:') ? photoPreview.src : (employees[empIndex].photo || '');
            
            // 更新员工信息
            employees[empIndex] = {
                ...employees[empIndex],
                name: name,
                gender: document.getElementById('editGender').value,
                birthDate: document.getElementById('editBirthDate').value,
                education: document.getElementById('editEducation').value,
                university: document.getElementById('editUniversity').value.trim(),
                major: document.getElementById('editMajor').value.trim(),
                maritimeExperience: document.getElementById('editMaritimeExperience').value.trim(),
                hireDate: document.getElementById('editHireDate').value,
                photo: photo,
                unit: document.getElementById('editUnit').value.trim(),
                role: document.getElementById('editRole').value,
                workStatus: document.getElementById('editWorkStatus').value,
                vtsHistory: vtsHistory,
                trainingRecords: trainingRecords,
                certificates: certificates,
                phone: phone,
                email: email,
                performance: document.getElementById('editPerformance').value.trim(),
                dutyDays: calculateDutyDays(vtsHistory) // 重新计算履历天数
            };
            
            updateEmployeesByOrganization();
            filteredEmployees = [...employees];
            renderEmployeeTable();
            updateFilters();
            updateStats();
            hideEditModal();
            saveToLocalStorage();
            showToast('员工信息更新成功！', 'success');
        }

        // 删除员工
        function deleteEmployee(id) {
            if (!currentUser || currentUser.userType !== 'admin') {
                showToast('没有权限执行此操作！', 'error');
                return;
            }
            
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            if (confirm(`确定要删除员工 ${employee.name} 吗？此操作不可恢复！`)) {
                employees = employees.filter(emp => emp.id !== id);
                filteredEmployees = [...employees];
                
                updateEmployeesByOrganization();
                
                const totalPages = Math.ceil(filteredEmployees.length / pageSize);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }
                
                renderEmployeeTable();
                updateStats();
                saveToLocalStorage();
                showToast('员工删除成功！', 'success');
            }
        }

        // 显示VTS履历详情
        function showDutyHistory(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const isAdmin = currentUser && currentUser.userType === 'admin';
            const dutyDays = employee.dutyDays || calculateDutyDays(employee.vtsHistory);
            const vtsHistoryCount = employee.vtsHistory ? employee.vtsHistory.length : 0;
            
            const dutyHistoryContent = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-medium">${employee.name} 的VTS履历详情</h4>
                        ${isAdmin ? `<button onclick="addNewVTSRecord(${id})" 
                                             class="bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                            添加VTS履历
                        </button>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-900 mb-2">履历统计</h5>
                            <div class="space-y-1 text-sm">
                                <div>履历阶段: <span class="font-medium">${vtsHistoryCount}</span></div>
                                <div>累计天数: <span class="font-medium">${dutyDays}天</span></div>
                                <div>平均每阶段: <span class="font-medium">${vtsHistoryCount > 0 ? Math.round((dutyDays / vtsHistoryCount) * 10) / 10 : 0}天</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-medium text-blue-900 mb-2">当前状态</h5>
                            <div class="text-sm text-blue-800">
                                <div>职务: ${employee.role}</div>
                                <div>状态: ${employee.workStatus}</div>
                                <div>单位: ${employee.unit}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VTS履历列表 -->
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">VTS履历记录</h5>
                        <div class="max-h-64 overflow-y-auto border rounded-lg">
                            ${employee.vtsHistory && employee.vtsHistory.length > 0 ? 
                                employee.vtsHistory.map((history, index) => {
                                    const startDate = history.startDate ? new Date(history.startDate) : null;
                                    const endDate = history.endDate ? new Date(history.endDate) : new Date();
                                    const days = startDate ? Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) : 0;
                                    
                                    return `
                                        <div class="p-3 border-b last:border-b-0 hover:bg-gray-50 transition-colors">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="font-medium text-gray-900">${history.position}</div>
                                                    <div class="text-sm text-gray-600">${history.location}</div>
                                                    <div class="text-sm text-gray-500">
                                                        ${history.startDate} - ${history.endDate || '至今'}
                                                    </div>
                                                    <div class="text-xs text-blue-600 mt-1">${days > 0 ? days + '天' : ''}</div>
                                                </div>
                                                ${isAdmin ? `<button onclick="removeVTSRecord(${id}, ${index})" 
                                                                     class="text-red-600 hover:text-red-900 focus:outline-none focus:underline text-sm">
                                                    删除
                                                </button>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('') :
                                '<div class="p-8 text-center text-gray-500">暂无VTS履历记录</div>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('dutyHistoryContent').innerHTML = dutyHistoryContent;
            document.getElementById('dutyHistoryModal').classList.add('show');
        }

        function hideDutyHistoryModal() {
            document.getElementById('dutyHistoryModal').classList.remove('show');
        }

        // 添加新的VTS履历记录（优化验证）
        function addNewVTSRecord(id) {
            const startDate = prompt('请输入开始日期 (格式: YYYY-MM-DD):');
            if (!startDate) return;
            
            if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate) || isNaN(Date.parse(startDate))) {
                showToast('日期格式不正确，请使用 YYYY-MM-DD 格式', 'error');
                return;
            }

            const endDate = prompt('请输入结束日期 (格式: YYYY-MM-DD，或留空表示至今):');
            if (endDate && (!/^\d{4}-\d{2}-\d{2}$/.test(endDate) || isNaN(Date.parse(endDate)))) {
                showToast('结束日期格式不正确，请使用 YYYY-MM-DD 格式', 'error');
                return;
            }

            // 验证日期逻辑
            if (endDate && new Date(endDate) <= new Date(startDate)) {
                showToast('结束日期必须晚于开始日期', 'error');
                return;
            }

            const position = prompt('请输入职务:\n1. 见习\n2. 值班员\n3. 值班长');
            if (!position || !['见习', '值班员', '值班长'].includes(position)) {
                if (position) showToast('职务输入不正确，请输入：见习、值班员或值班长', 'error');
                return;
            }

            const location = prompt('请输入工作地点:');
            if (!location || location.trim().length === 0) {
                showToast('工作地点不能为空', 'error');
                return;
            }

            const empIndex = employees.findIndex(emp => emp.id === id);
            if (empIndex !== -1) {
                if (!employees[empIndex].vtsHistory) {
                    employees[empIndex].vtsHistory = [];
                }
                
                employees[empIndex].vtsHistory.push({
                    startDate: startDate,
                    endDate: endDate || '',
                    position: position,
                    location: location.trim()
                });
                
                // 按开始日期排序
                employees[empIndex].vtsHistory.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                // 重新计算履历天数
                employees[empIndex].dutyDays = calculateDutyDays(employees[empIndex].vtsHistory);
                
                updateEmployeesByOrganization();
                showDutyHistory(id);
                renderEmployeeTable();
                updateStats();
                saveToLocalStorage();
                showToast('VTS履历添加成功！', 'success');
            }
        }

        // 删除VTS履历记录
        function removeVTSRecord(id, index) {
            if (confirm('确定要删除这条VTS履历记录吗？')) {
                const empIndex = employees.findIndex(emp => emp.id === id);
                if (empIndex !== -1 && employees[empIndex].vtsHistory) {
                    employees[empIndex].vtsHistory.splice(index, 1);
                    // 重新计算履历天数
                    employees[empIndex].dutyDays = calculateDutyDays(employees[empIndex].vtsHistory);
                    
                    updateEmployeesByOrganization();
                    showDutyHistory(id);
                    renderEmployeeTable();
                    updateStats();
                    saveToLocalStorage();
                    showToast('VTS履历记录删除成功！', 'success');
                }
            }
        }

        /*********************
         * 添加员工功能
         *********************/
        
        function showAddModal() {
            if (!currentUser || currentUser.userType !== 'admin') {
                showToast('没有权限执行此操作！', 'error');
                return;
            }
            
            document.getElementById('addEmployeeForm').reset();
            clearAllValidationErrors('new');
            
            // 清空容器
            document.getElementById('newVTSHistoryContainer').innerHTML = '';
            document.getElementById('newTrainingContainer').innerHTML = '';
            
            // 设置默认值
            document.getElementById('newUnit').value = getCurrentUserUnit();
            document.getElementById('newWorkStatus').value = 'VTS在岗';
            
            // 清空证书复选框
            const certCheckboxes = [
                'newCertCaptain', 'newCertChiefOfficer', 'newCertSecondOfficer', 'newCertThirdOfficer',
                'newCertChiefEngineer', 'newCertFirstEngineer', 'newCertSecondEngineer', 'newCertThirdEngineer', 'newCertElectrician'
            ];
            certCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            document.getElementById('newAge').value = '';
            clearPhoto('new');
            
            handleRoleChange('new');
            
            document.getElementById('addModal').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('newName').focus();
            }, 100);
        }

        function hideAddModal() {
            document.getElementById('addModal').classList.remove('show');
            clearAllValidationErrors('new');
        }

        function addEmployee() {
            clearAllValidationErrors('new');
            
            const name = document.getElementById('newName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            
            let hasErrors = false;
            
            // 验证姓名
            const nameError = validateName(name);
            if (nameError) {
                showValidationError('newName', nameError);
                hasErrors = true;
            }
            
            // 验证电话
            const phoneError = validatePhone(phone);
            if (phoneError) {
                showValidationError('newPhone', phoneError);
                hasErrors = true;
            }
            
            // 验证邮箱
            const emailError = validateEmail(email);
            if (emailError) {
                showValidationError('newEmail', emailError);
                hasErrors = true;
            }
            
            if (hasErrors) return;

            // 获取证书
            const certificates = [];
            const certCheckboxes = [
                { id: 'newCertCaptain', name: '船长' },
                { id: 'newCertChiefOfficer', name: '大副' },
                { id: 'newCertSecondOfficer', name: '二副' },
                { id: 'newCertThirdOfficer', name: '三副' },
                { id: 'newCertChiefEngineer', name: '轮机长' },
                { id: 'newCertFirstEngineer', name: '大管轮' },
                { id: 'newCertSecondEngineer', name: '二管轮' },
                { id: 'newCertThirdEngineer', name: '三管轮' },
                { id: 'newCertElectrician', name: '电机员' }
            ];
            
            certCheckboxes.forEach(cert => {
                const checkbox = document.getElementById(cert.id);
                if (checkbox && checkbox.checked) {
                    certificates.push(cert.name);
                }
            });

            // 获取VTS履历
            const vtsHistory = [];
            const vtsContainer = document.getElementById('newVTSHistoryContainer');
            const vtsItems = vtsContainer.querySelectorAll('.vts-history-item');
            vtsItems.forEach(item => {
                const startDate = item.querySelector('input[name="newVTSStartDate[]"]').value;
                const endDate = item.querySelector('input[name="newVTSEndDate[]"]').value;
                const position = item.querySelector('select[name="newVTSPosition[]"]').value;
                const location = item.querySelector('input[name="newVTSLocation[]"]').value;
                
                if (startDate && position && location) {
                    vtsHistory.push({ startDate, endDate, position, location });
                }
            });

            // 获取培训记录
            const trainingRecords = [];
            const trainingContainer = document.getElementById('newTrainingContainer');
            const trainingItems = trainingContainer.querySelectorAll('.vts-history-item');
            trainingItems.forEach(item => {
                const startDate = item.querySelector('input[name="newTrainingStartDate[]"]').value;
                const endDate = item.querySelector('input[name="newTrainingEndDate[]"]').value;
                const course = item.querySelector('input[name="newTrainingCourse[]"]').value;
                const institution = item.querySelector('input[name="newTrainingInstitution[]"]').value;
                
                if (startDate && course && institution) {
                    trainingRecords.push({ startDate, endDate, course, institution });
                }
            });

            // 获取照片
            const photoPreview = document.getElementById('newPhotoPreview');
            const photo = photoPreview.src.startsWith('data:') ? photoPreview.src : '';

            showLoading();

            const newEmp = {
                id: Math.max(...employees.map(emp => emp.id), 0) + 1,
                name: name,
                gender: document.getElementById('newGender').value,
                birthDate: document.getElementById('newBirthDate').value,
                unit: document.getElementById('newUnit').value.trim() || getCurrentUserUnit(),
                role: document.getElementById('newRole').value,
                workStatus: document.getElementById('newWorkStatus').value,
                phone: phone,
                email: email,
                certificates: certificates,
                education: document.getElementById('newEducation').value,
                university: document.getElementById('newUniversity').value.trim(),
                major: document.getElementById('newMajor').value.trim(),
                maritimeExperience: document.getElementById('newMaritimeExperience').value.trim(),
                hireDate: document.getElementById('newHireDate').value,
                photo: photo,
                vtsHistory: vtsHistory,
                trainingRecords: trainingRecords,
                dutyDays: calculateDutyDays(vtsHistory), // 计算履历天数
                performance: document.getElementById('newPerformance').value.trim()
            };
            
            setTimeout(() => {
                employees.push(newEmp);
                filteredEmployees = [...employees];
                
                updateEmployeesByOrganization();
                
                renderEmployeeTable();
                updateFilters();
                updateStats();
                hideAddModal();
                hideLoading();
                saveToLocalStorage();
                showToast('员工添加成功！', 'success');
            }, 500);
        }

        // 获取当前用户单位名称
        function getCurrentUserUnit() {
            if (!currentUser) return '';
            
            const unitMap = {
                '省厅': '山东海事局',
                '烟台分局': '烟台海事局',
                '青岛分局': '青岛海事局',
                '威海分局': '威海海事局',
                '日照分局': '日照海事局',
                '东营分局': '东营海事局',
                '潍坊分局': '潍坊海事局',
                '董家口分局': '董家口海事局',
                '滨州分局': '滨州海事局'
            };
            
            return unitMap[currentUser.organization] || '';
        }

        // 同步更新employeesByOrganization
        function updateEmployeesByOrganization() {
            Object.keys(employeesByOrganization).forEach(org => {
                employeesByOrganization[org] = [];
            });
            
            employees.forEach(emp => {
                const unitToOrgMap = {
                    '山东海事局': '省厅',
                    '烟台海事局': '烟台分局',
                    '青岛海事局': '青岛分局',
                    '威海海事局': '威海分局',
                    '日照海事局': '日照分局',
                    '东营海事局': '东营分局',
                    '潍坊海事局': '潍坊分局',
                    '董家口海事局': '董家口分局',
                    '滨州海事局': '滨州分局'
                };
                
                const org = unitToOrgMap[emp.unit];
                if (org && employeesByOrganization[org]) {
                    employeesByOrganization[org].push(emp);
                }
            });
        }

        /*********************
         * 批量操作功能
         *********************/
        
        function showBulkActions() {
            if (!currentUser || currentUser.userType !== 'admin') {
                showToast('没有权限执行此操作！', 'error');
                return;
            }
            updateSelectedCount();
            document.getElementById('bulkModal').classList.add('show');
        }

        function hideBulkModal() {
            document.getElementById('bulkModal').classList.remove('show');
        }

        function getSelectedEmployees() {
            const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        function updateSelectedCount() {
            const selectedCount = getSelectedEmployees().length;
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }

        function bulkDelete() {
            const selectedIds = getSelectedEmployees();
            if (selectedIds.length === 0) {
                showToast('请先选择员工', 'error');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedIds.length} 名员工吗？此操作不可恢复！`)) {
                employees = employees.filter(emp => !selectedIds.includes(emp.id));
                filteredEmployees = [...employees];
                updateEmployeesByOrganization();
                
                const totalPages = Math.ceil(filteredEmployees.length / pageSize);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }
                
                renderEmployeeTable();
                updateStats();
                hideBulkModal();
                saveToLocalStorage();
                showToast(`已删除 ${selectedIds.length} 名员工`, 'success');
            }
        }

        function bulkChangeStatus() {
            const selectedIds = getSelectedEmployees();
            if (selectedIds.length === 0) {
                showToast('请先选择员工', 'error');
                return;
            }
            
            const newStatus = prompt('请输入新的工作状态：\n1. VTS在岗\n2. 海事处\n3. 机关');
            const statusOptions = ['VTS在岗', '海事处', '机关'];
            
            if (newStatus && statusOptions.includes(newStatus)) {
                let updatedCount = 0;
                
                selectedIds.forEach(id => {
                    const empIndex = employees.findIndex(emp => emp.id === id);
                    if (empIndex !== -1) {
                        employees[empIndex].workStatus = newStatus;
                        updatedCount++;
                    }
                });
                
                updateEmployeesByOrganization();
                renderEmployeeTable();
                updateStats();
                hideBulkModal();
                saveToLocalStorage();
                showToast(`已更新 ${updatedCount} 名员工的工作状态`, 'success');
            } else if (newStatus) {
                showToast('输入的工作状态不正确', 'error');
            }
        }

        function bulkExport() {
            const selectedIds = getSelectedEmployees();
            if (selectedIds.length === 0) {
                showToast('请先选择员工', 'error');
                return;
            }
            
            const selectedEmployees = employees.filter(emp => selectedIds.includes(emp.id));
            exportEmployeesToCSV(selectedEmployees, '选中员工信息');
            hideBulkModal();
        }

        function addVTSRecord() {
            const selectedIds = getSelectedEmployees();
            if (selectedIds.length === 0) {
                showToast('请先选择员工', 'error');
                return;
            }
            
            const startDate = prompt('请输入开始日期 (格式: YYYY-MM-DD):');
            if (!startDate) return;
            
            if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate) || isNaN(Date.parse(startDate))) {
                showToast('日期格式不正确，请使用 YYYY-MM-DD 格式', 'error');
                return;
            }

            const endDate = prompt('请输入结束日期 (格式: YYYY-MM-DD，或留空表示至今):');
            if (endDate && (!/^\d{4}-\d{2}-\d{2}$/.test(endDate) || isNaN(Date.parse(endDate)))) {
                showToast('结束日期格式不正确，请使用 YYYY-MM-DD 格式', 'error');
                return;
            }

            if (endDate && new Date(endDate) <= new Date(startDate)) {
                showToast('结束日期必须晚于开始日期', 'error');
                return;
            }

            const position = prompt('请输入职务:\n1. 见习\n2. 值班员\n3. 值班长');
            if (!position || !['见习', '值班员', '值班长'].includes(position)) {
                if (position) showToast('职务输入不正确，请输入：见习、值班员或值班长', 'error');
                return;
            }

            const location = prompt('请输入工作地点:');
            if (!location || location.trim().length === 0) {
                showToast('工作地点不能为空', 'error');
                return;
            }

            selectedIds.forEach(id => {
                const empIndex = employees.findIndex(emp => emp.id === id);
                if (empIndex !== -1) {
                    if (!employees[empIndex].vtsHistory) {
                        employees[empIndex].vtsHistory = [];
                    }
                    
                    employees[empIndex].vtsHistory.push({
                        startDate: startDate,
                        endDate: endDate || '',
                        position: position,
                        location: location.trim()
                    });
                    
                    // 按开始日期排序
                    employees[empIndex].vtsHistory.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    
                    // 重新计算履历天数
                    employees[empIndex].dutyDays = calculateDutyDays(employees[empIndex].vtsHistory);
                }
            });
            
            updateEmployeesByOrganization();
            renderEmployeeTable();
            updateStats();
            hideBulkModal();
            saveToLocalStorage();
            showToast(`已为 ${selectedIds.length} 名员工添加VTS履历`, 'success');
        }

        function toggleSelectAll() {
            if (!currentUser || currentUser.userType !== 'admin') return;
            
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.employee-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedCount();
        }

        /*********************
         * 数据导出功能
         *********************/
        
        function exportToCSV() {
            exportEmployeesToCSV(filteredEmployees, '员工信息');
        }

        function exportEmployeesToCSV(employeeData, filename) {
            const headers = ['姓名', '性别', '年龄', '单位', '身份', '工作状态', '证书', '学历', '毕业院校', '专业', '入职日期', '涉海经历', '电话', '邮箱', 'VTS履历天数', '工作绩效'];
            const csvData = employeeData.map(emp => [
                emp.name, 
                emp.gender, 
                emp.birthDate ? calculateAgeFromBirthDate(emp.birthDate) : '', 
                emp.unit, 
                emp.role, 
                emp.workStatus, 
                emp.certificates ? emp.certificates.join(';') : '',
                emp.education,
                emp.university || '',
                emp.major || '',
                emp.hireDate || '',
                emp.maritimeExperience || '',
                emp.phone || '',
                emp.email || '',
                emp.dutyDays || calculateDutyDays(emp.vtsHistory),
                emp.performance || ''
            ]);
            
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => {
                    const value = String(field || '');
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','))
                .join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            showToast('数据导出成功！', 'success');
        }

        /*********************
         * 履历日历功能
         *********************/
        
        function showDutySchedule() {
            const calendarSection = document.getElementById('calendarSection');
            calendarSection.classList.remove('hidden');
            
            if (!calendar) {
                initializeCalendar();
            }
            
            calendarSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function hideCalendar() {
            document.getElementById('calendarSection').classList.add('hidden');
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            // 基于VTS履历生成日历事件
            const events = employees.flatMap(emp => {
                if (!emp.vtsHistory || emp.vtsHistory.length === 0) return [];
                
                return emp.vtsHistory.map(history => {
                    if (!history.startDate) return null;
                    
                    const startDate = history.startDate;
                    const endDate = history.endDate || new Date().toISOString().split('T')[0];
                    
                    return {
                        title: `${emp.name} - ${history.position}`,
                        start: startDate,
                        end: endDate,
                        backgroundColor: emp.role === '值班长' ? '#ef4444' : '#3b82f6',
                        borderColor: emp.role === '值班长' ? '#dc2626' : '#2563eb',
                        extendedProps: {
                            employeeId: emp.id,
                            employeeName: emp.name,
                            role: emp.role,
                            unit: emp.unit,
                            position: history.position,
                            location: history.location,
                            historyIndex: emp.vtsHistory.indexOf(history)
                        }
                    };
                }).filter(event => event !== null);
            });
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                locale: 'zh-cn',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                buttonText: {
                    today: '今天',
                    month: '月',
                    week: '周',
                    list: '列表'
                },
                editable: currentUser && currentUser.userType === 'admin',
                selectable: currentUser && currentUser.userType === 'admin',
                selectMirror: true,
                events: events,
                
                dateClick: function(info) {
                    if (currentUser && currentUser.userType === 'admin') {
                        const employeeName = prompt('请输入员工姓名:');
                        if (!employeeName) return;
                        
                        const employee = employees.find(emp => emp.name === employeeName);
                        if (!employee) {
                            showToast('未找到该员工', 'error');
                            return;
                        }
                        
                        const position = prompt('请输入职务:\n1. 见习\n2. 值班员\n3. 值班长');
                        if (!position || !['见习', '值班员', '值班长'].includes(position)) {
                            if (position) showToast('职务输入不正确', 'error');
                            return;
                        }
                        
                        const location = prompt('请输入工作地点:');
                        if (!location) return;
                        
                        if (!employee.vtsHistory) {
                            employee.vtsHistory = [];
                        }
                        
                        employee.vtsHistory.push({
                            startDate: info.dateStr,
                            endDate: '',
                            position: position,
                            location: location
                        });
                        
                        // 重新计算履历天数
                        employee.dutyDays = calculateDutyDays(employee.vtsHistory);
                        
                        // 重新初始化日历以显示新事件
                        calendar.destroy();
                        initializeCalendar();
                        
                        updateEmployeesByOrganization();
                        renderEmployeeTable();
                        updateStats();
                        saveToLocalStorage();
                        showToast('VTS履历添加成功！', 'success');
                    }
                },
                
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    if (confirm(`${props.employeeName} - ${props.position}\n${props.location}\n\n是否删除此VTS履历？`)) {
                        if (currentUser && currentUser.userType === 'admin') {
                            removeVTSRecord(props.employeeId, props.historyIndex);
                            info.event.remove();
                        }
                    }
                }
            });
            
            calendar.render();
        }

        /*********************
         * 履历分析功能
         *********************/
        
        function showDutyAnalysis() {
            generateDutyAnalysis();
            document.getElementById('analysisModal').classList.add('show');
        }

        function hideAnalysisModal() {
            document.getElementById('analysisModal').classList.remove('show');
        }

        function generateDutyAnalysis() {
            const totalEmployees = employees.length;
            const vtsOnDutyEmployees = employees.filter(emp => emp.workStatus === 'VTS在岗');
            const totalDutyDays = employees.reduce((sum, emp) => sum + (emp.dutyDays || calculateDutyDays(emp.vtsHistory)), 0);
            const avgDutyDays = totalEmployees > 0 ? Math.round((totalDutyDays / totalEmployees) * 10) / 10 : 0;

            // 按单位统计
            const unitStats = {};
            employees.forEach(emp => {
                if (!unitStats[emp.unit]) {
                    unitStats[emp.unit] = {
                        total: 0,
                        vtsOnDuty: 0,
                        dutyDays: 0,
                        supervisors: 0
                    };
                }
                unitStats[emp.unit].total++;
                if (emp.workStatus === 'VTS在岗') unitStats[emp.unit].vtsOnDuty++;
                if (emp.role === '值班长') unitStats[emp.unit].supervisors++;
                unitStats[emp.unit].dutyDays += emp.dutyDays || calculateDutyDays(emp.vtsHistory);
            });

            // 按身份统计
            const roleStats = {};
            employees.forEach(emp => {
                if (!roleStats[emp.role]) {
                    roleStats[emp.role] = { count: 0, dutyDays: 0 };
                }
                roleStats[emp.role].count++;
                roleStats[emp.role].dutyDays += emp.dutyDays || calculateDutyDays(emp.vtsHistory);
            });

            // 按工作状态统计
            const statusStats = {};
            employees.forEach(emp => {
                if (!statusStats[emp.workStatus]) {
                    statusStats[emp.workStatus] = { count: 0, dutyDays: 0 };
                }
                statusStats[emp.workStatus].count++;
                statusStats[emp.workStatus].dutyDays += emp.dutyDays || calculateDutyDays(emp.vtsHistory);
            });

            // 证书持有情况
            const certStats = {};
            employees.forEach(emp => {
                if (emp.certificates && emp.certificates.length > 0) {
                    emp.certificates.forEach(cert => {
                        certStats[cert] = (certStats[cert] || 0) + 1;
                    });
                }
            });

            // 履历天数分析
            const dutyRanges = {
                high: employees.filter(emp => (emp.dutyDays || calculateDutyDays(emp.vtsHistory)) > 1800).length, // 5年以上
                medium: employees.filter(emp => {
                    const days = emp.dutyDays || calculateDutyDays(emp.vtsHistory);
                    return days >= 730 && days <= 1800; // 2-5年
                }).length,
                low: employees.filter(emp => (emp.dutyDays || calculateDutyDays(emp.vtsHistory)) < 730).length // 2年以下
            };

            const analysisContent = `
                <div class="space-y-8">
                    <!-- 总体统计 -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">总体统计</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold text-blue-800">总人数</h4>
                                        <p class="text-3xl font-bold text-blue-600">${totalEmployees}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold text-green-800">VTS在岗人员</h4>
                                        <p class="text-3xl font-bold text-green-600">${vtsOnDutyEmployees.length}</p>
                                        <p class="text-sm text-green-600">${totalEmployees > 0 ? Math.round((vtsOnDutyEmployees.length / totalEmployees) * 100) : 0}%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold text-purple-800">累计履历</h4>
                                        <p class="text-3xl font-bold text-purple-600">${totalDutyDays}</p>
                                        <p class="text-sm text-purple-600">天</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-orange-50 p-6 rounded-lg border border-orange-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold text-orange-800">人均履历</h4>
                                        <p class="text-3xl font-bold text-orange-600">${avgDutyDays}</p>
                                        <p class="text-sm text-orange-600">天/人</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- 各单位统计 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">各单位统计</h4>
                            <div class="bg-white border rounded-lg overflow-hidden">
                                <div class="max-h-80 overflow-y-auto">
                                    ${Object.entries(unitStats).map(([unit, stats]) => `
                                        <div class="p-4 border-b last:border-b-0 hover:bg-gray-50 transition-colors">
                                            <div class="flex justify-between items-start mb-2">
                                                <h5 class="font-medium text-gray-900 text-sm">${unit}</h5>
                                                <span class="text-xs text-gray-500">${Math.round((stats.vtsOnDuty / stats.total) * 100)}% VTS在岗</span>
                                            </div>
                                            <div class="grid grid-cols-4 gap-2 text-xs text-gray-600 mb-2">
                                                <div>总数: ${stats.total}</div>
                                                <div>VTS: ${stats.vtsOnDuty}</div>
                                                <div>值班长: ${stats.supervisors}</div>
                                                <div>履历: ${stats.dutyDays}天</div>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${(stats.vtsOnDuty / stats.total) * 100}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- 工作状态分布 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">工作状态分布</h4>
                            <div class="space-y-3">
                                ${Object.entries(statusStats).map(([status, stats]) => {
                                    const avgDays = stats.count > 0 ? Math.round((stats.dutyDays / stats.count) * 10) / 10 : 0;
                                    const colorClass = getWorkStatusColor(status);
                                    return `
                                        <div class="p-4 border rounded-lg ${colorClass.replace('text-', 'border-').replace('100', '200').replace('800', '50')}">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="font-medium text-gray-900">${status}</span>
                                                <span class="text-sm text-gray-600">${stats.count}人</span>
                                            </div>
                                            <div class="flex justify-between text-sm text-gray-600">
                                                <span>总履历: ${stats.dutyDays}天</span>
                                                <span>人均: ${avgDays}天</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- 身份分布与效率 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">身份分布与履历</h4>
                            <div class="space-y-3">
                                ${Object.entries(roleStats).map(([role, stats]) => {
                                    const avgDays = stats.count > 0 ? Math.round((stats.dutyDays / stats.count) * 10) / 10 : 0;
                                    const colorClass = role === '值班长' ? 'bg-red-50 border-red-200' : 
                                                     role === '值班员' ? 'bg-blue-50 border-blue-200' :
                                                     role === '见习' ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200';
                                    return `
                                        <div class="p-4 ${colorClass} border rounded-lg">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="font-medium text-gray-900">${role}</span>
                                                <span class="text-sm text-gray-600">${stats.count}人</span>
                                            </div>
                                            <div class="flex justify-between text-sm text-gray-600">
                                                <span>总履历: ${stats.dutyDays}天</span>
                                                <span>人均: ${avgDays}天</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- 证书统计 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">证书持有情况</h4>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-3">
                                    ${Object.entries(certStats).map(([cert, count]) => `
                                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-900">${cert}</span>
                                            <span class="text-lg font-bold text-blue-600">${count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${Object.keys(certStats).length === 0 ? 
                                    '<div class="text-center text-gray-500 py-4">暂无证书数据</div>' : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>

                    <!-- VTS履历经验分析 -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">VTS履历经验分析</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h5 class="font-medium text-green-800">资深员工 (>5年)</h5>
                                        <p class="text-sm text-green-600">经验丰富，技能熟练</p>
                                    </div>
                                    <div class="text-3xl font-bold text-green-600">${dutyRanges.high}</div>
                                </div>
                            </div>
                            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h5 class="font-medium text-yellow-800">中级员工 (2-5年)</h5>
                                        <p class="text-sm text-yellow-600">具备基础经验，持续成长</p>
                                    </div>
                                    <div class="text-3xl font-bold text-yellow-600">${dutyRanges.medium}</div>
                                </div>
                            </div>
                            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h5 class="font-medium text-red-800">新进员工 (<2年)</h5>
                                        <p class="text-sm text-red-600">需要更多培训和指导</p>
                                    </div>
                                    <div class="text-3xl font-bold text-red-600">${dutyRanges.low}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 管理建议 -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4 flex items-center">
                            <svg class="h-5 w-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            管理建议与优化方向
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div>
                                        <h5 class="font-medium text-blue-900">VTS在岗率分析</h5>
                                        <p class="text-sm text-blue-800">
                                            当前VTS在岗率: ${totalEmployees > 0 ? Math.round((vtsOnDutyEmployees.length / totalEmployees) * 100) : 0}%
                                            ${vtsOnDutyEmployees.length < totalEmployees * 0.7 ? '，建议关注VTS人员调配' : '，VTS人员配置良好'}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div>
                                        <h5 class="font-medium text-blue-900">履历经验</h5>
                                        <p class="text-sm text-blue-800">
                                            人均履历天数: ${avgDutyDays}天
                                            ${avgDutyDays < 1095 ? '，可加强人员培训' : avgDutyDays > 2555 ? '，团队经验丰富' : '，履历经验适中'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div>
                                        <h5 class="font-medium text-blue-900">专业资质</h5>
                                        <p class="text-sm text-blue-800">
                                            证书覆盖: 共${Object.keys(certStats).length}种证书
                                            ${Object.keys(certStats).length < 4 ? '，建议加强人员培训' : '，专业资质良好'}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-orange-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div>
                                        <h5 class="font-medium text-blue-900">改进建议</h5>
                                        <p class="text-sm text-blue-800">
                                            重点培养新进员工VTS技能，加强资深员工与新员工的传帮带，优化人员配置，提升整体履历水平
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analysisContent').innerHTML = analysisContent;
        }

        /*********************
         * 重置数据功能
         *********************/
        
        function resetToDefaultData() {
            if (!currentUser || currentUser.userType !== 'admin') {
                showToast('没有权限执行此操作！', 'error');
                return;
            }
            
            const choice = confirm('确定要重置所有数据为初始状态吗？\n\n点击"确定"重置为原始数据\n点击"取消"保持当前数据');
            if (!choice) return;
            
            const clearStorage = confirm('是否同时清除本地存储的数据？\n\n点击"确定"清除本地存储（数据不会在刷新后保留）\n点击"取消"保留本地存储（数据会在刷新后恢复）');
            
            if (clearStorage) {
                clearLocalStorage();
            }
            
            showLoading();
            
            setTimeout(() => {
                // 重置为原始数据结构
                employeesByOrganization = {
                    '省厅': [
                        {
                            id: 1, name: '王局长', gender: '男', birthDate: '1976-03-15',
                            unit: '山东海事局', role: '值班长', workStatus: 'VTS在岗',
                            phone: '13800001111', email: 'wang@sd.vts.msa.gov.cn',
                            certificates: ['船长', '大副'], education: '研究生及以上', 
                            university: '大连海事大学', major: '航海技术', maritimeExperience: '20年海事管理经验，曾任船长8年',
                            hireDate: '2010-03-15', photo: '',
                            vtsHistory: [
                                {startDate: '2010-03-15', endDate: '2015-06-30', position: '值班员', location: '青岛分局'},
                                {startDate: '2015-07-01', endDate: '2020-12-31', position: '值班长', location: '烟台分局'},
                                {startDate: '2021-01-01', endDate: '', position: '值班长', location: '山东海事局'}
                            ],
                            trainingRecords: [
                                {startDate: '2020-05-10', endDate: '2020-05-20', course: 'VTS高级管理培训', institution: '交通部海事局'},
                                {startDate: '2022-03-15', endDate: '2022-03-25', course: 'ECDIS系统培训', institution: '大连海事大学'}
                            ],
                            performance: '2023年荣获"优秀VTS管理者"称号，主导VTS系统升级项目，发表《现代VTS管理技术研究》论文，获得山东省科技进步三等奖。'
                        },
                        {
                            id: 2, name: '李副局长', gender: '男', birthDate: '1979-06-20',
                            unit: '山东海事局', role: '值班长', workStatus: 'VTS在岗',
                            phone: '13800001112', email: 'li@sd.vts.msa.gov.cn',
                            certificates: ['船长', '轮机长'], education: '研究生及以上',
                            university: '上海海事大学', major: '轮机工程', maritimeExperience: '18年海事工作经历，船舶服务12年',
                            hireDate: '2012-08-01', photo: '',
                            vtsHistory: [
                                {startDate: '2012-08-01', endDate: '2018-12-31', position: '值班员', location: '威海分局'},
                                {startDate: '2019-01-01', endDate: '', position: '值班长', location: '山东海事局'}
                            ],
                            trainingRecords: [
                                {startDate: '2021-09-01', endDate: '2021-09-10', course: '港口交通管理培训', institution: '中国海事局培训中心'}
                            ],
                            performance: '负责全省VTS协调工作，2022年全国VTS技能比武二等奖，参与制定《山东省VTS管理规范》标准。'
                        }
                    ],
                    '青岛分局': [
                        {
                            id: 3, name: '张伟', gender: '男', birthDate: '1989-03-15',
                            unit: '青岛海事局', role: '值班长', workStatus: 'VTS在岗',
                            phone: '13800138001', email: 'zhangwei@qd.vts.msa.gov.cn',
                            certificates: ['船长', '大副'], education: '本科', 
                            university: '青岛科技大学', major: '海洋技术', maritimeExperience: '10年VTS工作经验，5年船舶值班经历',
                            hireDate: '2014-07-01', photo: '',
                            vtsHistory: [
                                {startDate: '2014-07-01', endDate: '2018-06-30', position: '见习', location: '青岛海事局'},
                                {startDate: '2018-07-01', endDate: '2021-12-31', position: '值班员', location: '青岛海事局'},
                                {startDate: '2022-01-01', endDate: '', position: '值班长', location: '青岛海事局'}
                            ],
                            trainingRecords: [
                                {startDate: '2020-04-15', endDate: '2020-04-25', course: 'VTS操作员培训', institution: '青岛海事局'}
                            ],
                            performance: '青岛港区值班长，经验丰富。2023年青岛分局技能比武一等奖，多次获得月度优秀员工。'
                        },
                        {
                            id: 4, name: '李红', gender: '女', birthDate: '1996-07-01',
                            unit: '青岛海事局', role: '值班员', workStatus: 'VTS在岗',
                            phone: '13800138002', email: 'lihong@qd.vts.msa.gov.cn',
                            certificates: ['大副', '二副'], education: '本科',
                            university: '中国海洋大学', major: '港口航道与海岸工程', maritimeExperience: '6年海事工作经验',
                            hireDate: '2018-03-01', photo: '',
                            vtsHistory: [
                                {startDate: '2018-03-01', endDate: '2020-02-29', position: '见习', location: '青岛海事局'},
                                {startDate: '2020-03-01', endDate: '', position: '值班员', location: '青岛海事局'}
                            ],
                            trainingRecords: [],
                            performance: '青岛港VTS操作员，工作认真负责，连续两年获得优秀员工称号。'
                        }
                    ],
                    '烟台分局': [],
                    '威海分局': [],
                    '日照分局': [],
                    '东营分局': [],
                    '潍坊分局': [],
                    '董家口分局': [],
                    '滨州分局': []
                };
                
                // 计算每个员工的履历天数
                Object.values(employeesByOrganization).forEach(orgEmployees => {
                    orgEmployees.forEach(emp => {
                        emp.dutyDays = calculateDutyDays(emp.vtsHistory);
                    });
                });
                
                if (!clearStorage) {
                    saveToLocalStorage(); // 如果不清除本地存储，保存重置后的数据
                }
                
                loadEmployeeData();
                hideLoading();
                showToast('数据已重置为初始状态！', 'success');
            }, 1000);
        }

        /*********************
         * 键盘导航支持
         *********************/
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                if (openModals.length > 0) {
                    openModals.forEach(modal => modal.classList.remove('show'));
                }
                if (!document.getElementById('calendarSection').classList.contains('hidden')) {
                    hideCalendar();
                }
            }
            
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                const searchInput = document.getElementById('searchInput');
                if (searchInput && currentUser) {
                    searchInput.focus();
                }
            }
        });

        /*********************
         * 事件监听器初始化
         *********************/
        
        function initEventListeners() {
            const filterElements = [
                'searchInput', 'unitFilter', 'roleFilter', 'statusFilter', 
                'certificateFilter', 'educationFilter'
            ];
            
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const eventType = element.tagName === 'INPUT' ? 'input' : 'change';
                    element.addEventListener(eventType, debouncedFilter);
                }
            });

            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('employee-checkbox')) {
                    updateSelectedCount();
                }
            });
            
            document.addEventListener('submit', function(e) {
                if (e.target.id !== 'loginForm' && e.target.id !== 'registerForm') {
                    e.preventDefault();
                }
            });

            // 添加实时验证监听器
            ['newName', 'newPhone', 'newEmail', 'editName', 'editPhone', 'editEmail', 
             'regUsername', 'regPassword', 'regPasswordConfirm', 'regRealName'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        clearValidationError(fieldId);
                    });
                }
            });
        }

        /*********************
         * 页面加载完成后初始化
         *********************/
        
        document.addEventListener('DOMContentLoaded', function() {
            // 首先尝试从本地存储加载数据
            const hasLocalData = loadFromLocalStorage();
            
            if (hasLocalData) {
                showToast('已加载本地保存的数据', 'success');
            }
            
            // 确保所有员工都有履历天数
            Object.values(employeesByOrganization).forEach(orgEmployees => {
                orgEmployees.forEach(emp => {
                    if (!emp.dutyDays) {
                        emp.dutyDays = calculateDutyDays(emp.vtsHistory);
                    }
                });
            });
            
            initEventListeners();
            showPage('loginPage');
            
            setTimeout(() => {
                if (hasLocalData) {
                    showToast('系统已恢复您之前的数据，添加的信息在刷新后仍会保留', 'info');
                } else {
                    showToast('欢迎使用海事局VTS值班人事管理系统', 'info');
                }
            }, 1000);
        });

        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && currentUser) {
                updateStats();
            }
        });
    </script>
</body>
</html>
